<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidu-ai视频抽卡积分消耗计算平台-易专属使用</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 jsrsasign 用于前端生成 JWT (智谱API鉴权必备) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.9.0/jsrsasign-all-min.js"></script>
    
    <!-- 引入 Mammoth.js 用于解析 .docx 文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        /* 七彩高斯模糊背景动画 */
        body { 
            background-color: #050505;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* 定义极光/全息色动画 */
        @keyframes aurora-1 {
            0%, 100% { top: -10%; left: -10%; transform: rotate(0deg) scale(1); }
            50% { top: 20%; left: 10%; transform: rotate(120deg) scale(1.2); }
        }
        @keyframes aurora-2 {
            0%, 100% { bottom: -10%; right: -10%; transform: rotate(0deg) scale(1); }
            50% { bottom: 10%; right: 10%; transform: rotate(-120deg) scale(1.1); }
        }
        @keyframes aurora-3 {
            0%, 100% { top: 40%; right: 20%; transform: translate(0, 0) scale(1); }
            50% { top: 60%; right: 40%; transform: translate(-30px, 30px) scale(0.9); }
        }

        /* 模态框进出动画 */
        @keyframes modal-pop {
            0% { opacity: 0; transform: scale(0.95) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* 抽卡动画 */
        @keyframes gacha-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes gacha-flash {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 抽象文字浮动动画 */
        @keyframes abstract-float {
            0%, 100% { transform: translate(-50%, -50%) rotate(-2deg); }
            50% { transform: translate(-50%, -55%) rotate(2deg); }
        }

        /* 危险页面震动动画 */
        @keyframes extreme-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
        
        /* 强制日期图标白色 */
        ::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.6; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. 图标组件 ---
        const IconWrapper = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Zap = ({ className }) => <IconWrapper className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></IconWrapper>;
        const TrendingDown = ({ className }) => <IconWrapper className={className}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></IconWrapper>;
        const Target = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></IconWrapper>;
        const BarChart2 = ({ className }) => <IconWrapper className={className}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></IconWrapper>;
        const AlertTriangle = ({ className }) => <IconWrapper className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconWrapper>;
        const PlusCircle = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></IconWrapper>;
        const Save = ({ className }) => <IconWrapper className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconWrapper>;
        const History = ({ className }) => <IconWrapper className={className}><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path></IconWrapper>;
        const Trash2 = ({ className }) => <IconWrapper className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const Users = ({ className }) => <IconWrapper className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconWrapper>;
        const Edit2 = ({ className }) => <IconWrapper className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></IconWrapper>;
        const X = ({ className }) => <IconWrapper className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconWrapper>;
        const Download = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconWrapper>;
        const ChevronRight = ({ className }) => <IconWrapper className={className}><polyline points="9 18 15 12 9 6"></polyline></IconWrapper>;
        const Gamepad2 = ({ className }) => <IconWrapper className={className}><line x1="6" y1="12" x2="10" y2="12"></line><line x1="8" y1="10" x2="8" y2="14"></line><line x1="15" y1="13" x2="15.01" y2="13"></line><line x1="18" y1="11" x2="18.01" y2="11"></line><rect x="2" y="6" width="20" height="12" rx="2"></rect></IconWrapper>;
        const Flame = ({ className }) => <IconWrapper className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></IconWrapper>;
        const Clapperboard = ({ className }) => <IconWrapper className={className}><rect x="2" y="6" width="20" height="12" rx="2" /><path d="M2 12h20" /><path d="M6 6v6" /><path d="M12 6v6" /><path d="M18 6v6" /></IconWrapper>;
        const Wand2 = ({ className }) => <IconWrapper className={className}><path d="m19 2 2 2-2 2-2-2 2-2Z"/><path d="m5 7 2 2-2 2-2-2 2-2Z"/><path d="m21.5 12.5-7 7-9-9 7-7 9 9Z"/><path d="m15 21 2-2"/></IconWrapper>;
        const Copy = ({ className }) => <IconWrapper className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></IconWrapper>;
        const Sparkles = ({ className }) => <IconWrapper className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconWrapper>;
        const BrainCircuit = ({ className }) => <IconWrapper className={className}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.284"/><path d="M17.97 14.716A4 4 0 0 1 16 18"/></IconWrapper>;
        const FileText = ({ className }) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></IconWrapper>;
        const ImagePlus = ({ className }) => <IconWrapper className={className}><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path><line x1="16" y1="5" x2="22" y2="5"></line><line x1="19" y1="2" x2="19" y2="8"></line><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></IconWrapper>;
        const CheckCircle = ({ className }) => <IconWrapper className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconWrapper>;
        const AlertCircle = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconWrapper>;
        const Send = ({ className }) => <IconWrapper className={className}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></IconWrapper>;

        // --- 2. 基础 UI 组件 (七彩高斯风) ---
        const Card = ({ children, className = "", onClick }) => (
            <div 
                onClick={onClick}
                className={`relative backdrop-blur-2xl bg-white/5 border border-white/10 rounded-2xl p-6 shadow-[0_8px_32px_rgba(0,0,0,0.3)] overflow-hidden group transition-all duration-300 ${onClick ? 'cursor-pointer hover:bg-white/10 hover:border-white/20 hover:scale-[1.01] hover:shadow-[0_15px_40px_rgba(0,0,0,0.4)]' : ''} ${className}`}
            >
                <div className="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
                <div className="relative z-10">{children}</div>
            </div>
        );

        const Badge = ({ children, type = "neutral" }) => {
            const styles = {
                neutral: "bg-white/5 text-white/60 border-white/10",
                success: "bg-emerald-500/10 text-emerald-300 border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.1)]",
                danger: "bg-rose-500/10 text-rose-300 border-rose-500/20 shadow-[0_0_10px_rgba(244,63,94,0.1)]",
                warning: "bg-amber-500/10 text-amber-300 border-amber-500/20",
                legendary: "bg-yellow-500/20 text-yellow-200 border-yellow-500/30 shadow-[0_0_15px_rgba(234,179,8,0.4)]",
                script: "bg-indigo-500/20 text-indigo-200 border-indigo-500/30"
            };
            return <span className={`px-2.5 py-1 rounded-full border text-[10px] font-bold uppercase tracking-wider ${styles[type] || styles.neutral}`}>{children}</span>;
        };

        // --- Vidu Prompt Director Tools ---
        const VIDU_LIBRARY = {
            angle: ["正面", "侧面", "四分之三侧面", "背面", "低角度仰拍", "高角度俯拍", "平视镜头", "鸟瞰镜头", "过肩镜头(Over the shoulder)", "镜头环绕"],
            shotSize: ["极致特写", "特写", "近景", "中景", "中全景", "全景", "远景"],
            dynamics: ["静态 (几乎不动)", "小动态 (呼吸/眼神/衣摆)", "中动态 (走动/转身/抬手)", "大动态 (冲刺/爆发-慎用)"],
            cameraMove: ["static shot", "move left", "move right", "move up", "move down", "zoom in", "pull back", "pan left", "pan right", "follow hand", "camera shake", "time-lapse shot", "macro shot", "FPV shot", "aerial shot"]
        };

        // --- 核心：API 逻辑 ---
        const generateZhipuJWT = (apiKey) => {
            try {
                const [id, secret] = apiKey.split('.');
                if (!id || !secret) return null;
                const header = { alg: 'HS256', sign_type: 'SIGN' };
                const now = Date.now();
                const payload = { api_key: id, exp: now + 3600 * 1000, timestamp: now };
                return KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(payload), secret);
            } catch (e) {
                console.error("JWT Generation Failed:", e);
                return null;
            }
        };
        
        // Key Sanitizer
        const cleanKey = (key) => key ? key.replace(/[^\x00-\x7F]/g, "").trim() : "";

        const DirectorModal = ({ onClose }) => {
            const [shots, setShots] = useState([]); // 初始为空，不显示手动框架
            const [rawInput, setRawInput] = useState("");
            const [isAiProcessing, setIsAiProcessing] = useState(false);
            const fileInputRef = useRef(null);
            
            // Image Refs
            const charImgRef = useRef(null);
            const sceneImgRef = useRef(null);
            const [charImg, setCharImg] = useState(null);
            const [sceneImg, setSceneImg] = useState(null);
            
            // API States
            const [provider, setProvider] = useState(localStorage.getItem('vidu_ai_provider') || 'offline'); 
            const [zhipuKey, setZhipuKey] = useState(localStorage.getItem('zhipu_api_key') || '');
            const [deepseekKey, setDeepseekKey] = useState(localStorage.getItem('deepseek_api_key') || '');
            const [siliconFlowKey, setSiliconFlowKey] = useState(localStorage.getItem('siliconflow_api_key') || '');
            const [showApiSettings, setShowApiSettings] = useState(false);
            
            // API Test Status
            const [apiStatus, setApiStatus] = useState({ loading: false, success: null, msg: '' });
            
            // AI Chat Assistant States
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState("");
            const [isChatLoading, setIsChatLoading] = useState(false);

            useEffect(() => {
                localStorage.setItem('vidu_ai_provider', provider);
                if (zhipuKey) localStorage.setItem('zhipu_api_key', cleanKey(zhipuKey));
                if (deepseekKey) localStorage.setItem('deepseek_api_key', cleanKey(deepseekKey));
                if (siliconFlowKey) localStorage.setItem('siliconflow_api_key', cleanKey(siliconFlowKey));
            }, [provider, zhipuKey, deepseekKey, siliconFlowKey]);

            // --- API 测试功能 ---
            const testConnection = async (testProvider) => {
                setApiStatus({ loading: true, success: null, msg: 'Testing...' });
                let endpoint, headers, body;
                
                try {
                    if (testProvider === 'zhipu') {
                        const k = cleanKey(zhipuKey);
                        if (!k) throw new Error("Key为空");
                        const token = generateZhipuJWT(k);
                        if(!token) throw new Error("JWT生成失败");
                        endpoint = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
                        headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                        body = JSON.stringify({ model: "glm-4-flash", messages: [{ role: "user", content: "Hi" }] });
                    } else if (testProvider === 'deepseek') {
                         const k = cleanKey(deepseekKey);
                         if (!k) throw new Error("Key为空");
                        endpoint = 'https://api.deepseek.com/chat/completions';
                        headers = { 'Authorization': `Bearer ${k}`, 'Content-Type': 'application/json' };
                        body = JSON.stringify({ model: "deepseek-chat", messages: [{ role: "user", content: "Hi" }], stream: false });
                    } else if (testProvider === 'siliconflow') {
                         const k = cleanKey(siliconFlowKey);
                         if (!k) throw new Error("Key为空");
                        endpoint = 'https://api.siliconflow.cn/v1/chat/completions';
                        headers = { 'Authorization': `Bearer ${k}`, 'Content-Type': 'application/json' };
                        body = JSON.stringify({ model: "deepseek-ai/DeepSeek-V3", messages: [{ role: "user", content: "Hi" }], stream: false });
                    } else {
                        throw new Error("离线模式无需测试");
                    }

                    const res = await fetch(endpoint, { method: 'POST', headers, body });
                    if (res.ok) {
                        setApiStatus({ loading: false, success: true, msg: '连接成功 (200 OK)' });
                        setTimeout(() => setApiStatus({ ...apiStatus, success: null, msg: '' }), 3000);
                    } else {
                        throw new Error(`连接失败: HTTP ${res.status}`);
                    }
                } catch (e) {
                    setApiStatus({ loading: false, success: false, msg: e.message });
                }
            };

            const generatePrompt = (shot) => {
                const dynamicsKey = shot.dynamics?.split(" ")[0] || ""; 
                let safeFace = shot.face;
                const noFaceShots = ["背面", "远景", "全景", "极致特写"];
                const noFaceAngles = ["背面", "鸟瞰镜头"];
                const allowFaceAngles = ["正面", "侧面", "四分之三侧面"];
                const allowFaceShots = ["特写", "近景", "中景"];
                const canHaveFace = allowFaceAngles.includes(shot.angle) && allowFaceShots.includes(shot.shotSize);

                if (!canHaveFace || noFaceShots.some(s => shot.shotSize.includes(s)) || noFaceAngles.some(a => shot.angle.includes(a))) {
                    safeFace = ""; 
                }

                const subjectWithDynamics = shot.subject ? `${shot.subject}，${dynamicsKey}` : "";

                const elements = [
                    shot.angle,
                    shot.shotSize,
                    subjectWithDynamics,
                    safeFace,
                    shot.background,
                    "画面精致清晰",
                    "2D anime style",
                    "8K超清",
                    "色调统一"
                ].filter(e => e && e.trim() !== "");

                return `${elements.join("，")}，${shot.cameraMove}`;
            };

            const fullPrompt = shots.map((s, i) => `${i + 1}) ${generatePrompt(s)}`).join("\n");

            const copyToClipboard = () => {
                if (!fullPrompt) return;
                const textarea = document.createElement('textarea');
                textarea.value = fullPrompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert("已复制到剪贴板！");
            };

            // AI Chat Assistant Functions
            const addChatMessage = (role, content) => {
                setChatMessages(prev => [...prev, { role, content, id: Date.now() }]);
            };

            const sendChatMessage = async () => {
                if (!chatInput.trim() || isChatLoading) return;
                
                const userMessage = chatInput.trim();
                setChatInput("");
                setIsChatLoading(true);
                
                // Add user message to chat
                addChatMessage("user", userMessage);
                
                // Prepare system prompt for improving prompt generation
                const systemPrompt = `你是专业的视频生成提示词优化师，专门帮助用户改进Vidu视频生成的提示词。
                用户可能提供以下类型的信息：
                1. 原始提示词（需要优化）
                2. 期望效果描述（需要转换为标准提示词）
                3. 对现有提示词的修改建议
                4. 特定风格、场景或技术要求
                
                你的任务是根据用户需求生成或优化提示词，并解释优化理由。
                如果用户询问如何改进提示词，请提供具体的技术性建议。
                如果用户提供原始文本，请将其转换为高质量的视频生成提示词。
                使用中文回复，保持专业而友好的语气。`;

                try {
                    let responseContent = "";
                    
                    if (provider === 'offline') {
                        // 离线模式下的模拟响应
                        responseContent = `收到您的请求："${userMessage}"\n\n当前处于离线模式，无法调用AI服务。建议您切换到在线模式以获得更智能的提示词优化服务。`;
                    } else {
                        let endpoint, headers, body;
                        
                        if (provider === 'zhipu') {
                            const token = generateZhipuJWT(cleanKey(zhipuKey));
                            if (!token) throw new Error("Key无效");
                            endpoint = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
                            headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                            body = JSON.stringify({ 
                                model: "glm-4-flash", 
                                messages: [
                                    { role: "system", content: systemPrompt },
                                    ...chatMessages.map(msg => ({ role: msg.role, content: msg.content })),
                                    { role: "user", content: userMessage }
                                ], 
                                temperature: 0.6 
                            });
                        } else if (provider === 'deepseek') {
                            const k = cleanKey(deepseekKey);
                            if (!k) throw new Error("Key无效");
                            endpoint = 'https://api.deepseek.com/chat/completions';
                            headers = { 'Authorization': `Bearer ${k}`, 'Content-Type': 'application/json' };
                            body = JSON.stringify({ 
                                model: "deepseek-chat", 
                                messages: [
                                    { role: "system", content: systemPrompt },
                                    ...chatMessages.map(msg => ({ role: msg.role, content: msg.content })),
                                    { role: "user", content: userMessage }
                                ], 
                                temperature: 0.6, 
                                stream: false 
                            });
                        } else if (provider === 'siliconflow') {
                            const k = cleanKey(siliconFlowKey);
                            if (!k) throw new Error("Key无效");
                            endpoint = 'https://api.siliconflow.cn/v1/chat/completions';
                            headers = { 'Authorization': `Bearer ${k}`, 'Content-Type': 'application/json' };
                            body = JSON.stringify({ 
                                model: "deepseek-ai/DeepSeek-V3", 
                                messages: [
                                    { role: "system", content: systemPrompt },
                                    ...chatMessages.map(msg => ({ role: msg.role, content: msg.content })),
                                    { role: "user", content: userMessage }
                                ], 
                                temperature: 0.6, 
                                stream: false 
                            });
                        }
                        
                        const response = await fetch(endpoint, { method: 'POST', headers, body });
                        if (!response.ok) throw new Error(`API请求失败: ${response.status}`);
                        
                        const data = await response.json();
                        responseContent = data.choices[0].message.content;
                    }
                    
                    // Add AI response to chat
                    addChatMessage("assistant", responseContent);
                } catch (error) {
                    console.error("Chat error:", error);
                    addChatMessage("assistant", `抱歉，发送消息时出现错误：${error.message}。请检查API配置并重试。`);
                } finally {
                    setIsChatLoading(false);
                }
            };

            // Handle Enter key press for chat
            const handleChatKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            };

            const handleImgUpload = (e, setter) => {
                const file = e.target.files[0];
                if (file) setter(URL.createObjectURL(file));
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (file.name.endsWith('.docx')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        mammoth.extractRawText({arrayBuffer: e.target.result})
                            .then(result => setRawInput(result.value))
                            .catch(err => alert("DOCX 解析失败: " + err.message));
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = e => setRawInput(e.target.result);
                    reader.readAsText(file);
                } else {
                    alert("仅支持 .docx 或 .txt 文件");
                }
            };

            const handleAiPolish = async () => {
                if (!rawInput.trim()) return alert("请先输入一段剧本素材");
                setIsAiProcessing(true);
                let aiResults = [];
                const systemPrompt = `你是"酱油动漫"体系的专业Vidu分镜导演。任务：分析用户的[剧本片段]，将其拆解为【多个】分镜镜头列表。
                输出格式：JSON数组 [{angle, shotSize, subject, face, background, dynamics, cameraMove}, ...]
                规则：
                1. 默认一切主体来自参考图，不新增设定。
                2. 词库严格限制：
                   angle: 正面, 侧面, 四分之三侧面, 背面, 低角度仰拍, 高角度俯拍, 平视镜头, 鸟瞰镜头, 过肩镜头(Over the shoulder), 镜头环绕
                   shotSize: 极致特写, 特写, 近景, 中景, 中全景, 全景, 远景
                   dynamics: 静态 (几乎不动), 小动态 (呼吸/眼神/衣摆), 中动态 (走动/转身/抬手), 大动态 (冲刺/爆发-慎用)
                   cameraMove: static shot, move left, move right, move up, move down, zoom in, pull back, pan left, pan right, follow hand, camera shake, time-lapse shot, macro shot, FPV shot, aerial shot
                3. face: 仅在(正面/侧面/四分之三侧面)且(特写/近景/中景)时输出"眼睛精致, 五官清晰"；否则留空。
                4. subject: 必须包含"人物+动作+表情+站位关系"。中文。
                5. background: 简洁中文描述。
                仅输出JSON数组。`;

                try {
                    let responseData;
                    if (provider === 'zhipu') {
                        const token = generateZhipuJWT(cleanKey(zhipuKey));
                        if (!token) throw new Error("Key无效");
                        const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: "glm-4-flash", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: rawInput }], temperature: 0.2 })
                        });
                        if (!response.ok) throw new Error("Zhipu API Error");
                        responseData = await response.json();
                    } else if (provider === 'deepseek') {
                         const k = cleanKey(deepseekKey);
                        const response = await fetch('https://api.deepseek.com/chat/completions', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${k}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: rawInput }], temperature: 0.2, stream: false })
                        });
                        if (!response.ok) throw new Error("DeepSeek API Error");
                        responseData = await response.json();
                    } else if (provider === 'siliconflow') {
                        const k = cleanKey(siliconFlowKey);
                        const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${k}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: "deepseek-ai/DeepSeek-V3", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: rawInput }], temperature: 0.2, stream: false })
                        });
                        if (!response.ok) throw new Error("SiliconFlow API Error");
                        responseData = await response.json();
                    } else if (provider === 'offline') {
                         aiResults = [{ angle: "正面", shotSize: "中景", subject: rawInput.substring(0, 20), background: "简单背景", dynamics: "小动态 (呼吸/眼神/衣摆)", cameraMove: "static shot", face: "五官精致" }];
                    }
                    
                    if (responseData) {
                        const content = responseData.choices[0].message.content.replace(/```json|```/g, '').trim();
                        let parsedData = JSON.parse(content);
                        if (!Array.isArray(parsedData)) parsedData = [parsedData];
                        aiResults = parsedData;
                    }
                } catch (e) {
                    console.warn("AI Request Failed:", e);
                    alert(`${provider.toUpperCase()} 失败（${e.message}）。转为离线模式。`);
                     aiResults = [{ angle: "正面", shotSize: "中景", subject: rawInput.substring(0, 15), background: "离线背景", dynamics: "小动态", cameraMove: "static shot", face: "" }];
                }

                const newShots = aiResults.map((res, idx) => ({
                    id: Date.now() + idx,
                    angle: res.angle || "正面",
                    shotSize: res.shotSize || "中景",
                    subject: res.subject || "主体描述",
                    face: res.face || "",
                    background: res.background || "",
                    dynamics: res.dynamics || "小动态 (呼吸/眼神/衣摆)",
                    cameraMove: res.cameraMove || "static shot"
                }));
                setShots(newShots);
                setIsAiProcessing(false);
            };

            const addShot = () => {
                setShots([...shots, { id: Date.now(), angle: "正面", shotSize: "中景", subject: "", face: "", background: "", dynamics: "小动态 (呼吸/眼神/衣摆)", cameraMove: "static shot" }]);
            };

            const updateShot = (id, field, value) => {
                setShots(shots.map(s => s.id === id ? { ...s, [field]: value } : s));
            };

            const removeShot = (id) => {
                setShots(shots.filter(s => s.id !== id));
            };

            // 动态计算是否允许加脸 (UI反馈)
            const canHaveFace = (angle, shotSize) => {
                 const allowFaceAngles = ["正面", "侧面", "四分之三侧面"];
                 const allowFaceShots = ["特写", "近景", "中景"];
                 return allowFaceAngles.includes(angle) && allowFaceShots.includes(shotSize);
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-[fadeIn_0.2s_ease-out]" onClick={onClose}>
                    <div className="bg-[#0f111a] border border-purple-500/30 rounded-2xl w-full max-w-6xl h-[90vh] flex flex-col shadow-[0_0_60px_rgba(168,85,247,0.15)] animate-[modal-pop_0.3s_cubic-bezier(0.34,1.56,0.64,1)] overflow-hidden" onClick={e => e.stopPropagation()}>
                        
                        {/* Header */}
                        <div className="flex justify-between items-center p-5 border-b border-white/10 bg-gradient-to-r from-purple-900/20 to-transparent flex-shrink-0">
                            <div className="flex items-center gap-3">
                                <Wand2 className="w-6 h-6 text-purple-400" />
                                <div><h3 className="text-xl font-bold text-white">Vidu 全自动导演工作台</h3><p className="text-[10px] text-white/40 uppercase tracking-widest">AI Auto-Director & Script Parsing</p></div>
                            </div>
                            <button onClick={onClose}><X className="w-6 h-6 text-white/40 hover:text-white" /></button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-hidden flex flex-col md:flex-row">
                            {/* 左侧：输入与控制区 */}
                            <div className="w-full md:w-1/3 bg-black/20 p-6 border-r border-white/10 flex flex-col gap-5 overflow-y-auto custom-scrollbar">
                                {/* 1. 资产上传 (显眼位置) */}
                                <div className="space-y-2">
                                    <div className="text-[10px] font-bold text-cyan-300 uppercase flex items-center gap-1"><ImagePlus className="w-3 h-3" /> Step 1: Upload Assets (素材)</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="aspect-video border border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 hover:border-white/40 transition-all relative overflow-hidden group" onClick={() => charImgRef.current.click()}>
                                            {charImg ? <img src={charImg} className="absolute inset-0 w-full h-full object-cover" /> : <div className="text-center text-white/30 group-hover:text-white/50"><Users className="w-6 h-6 mx-auto mb-1" /><span className="text-[9px]">角色参考图</span></div>}
                                            <input type="file" ref={charImgRef} onChange={e => handleImgUpload(e, setCharImg)} className="hidden" accept="image/*" />
                                        </div>
                                        <div className="aspect-video border border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 hover:border-white/40 transition-all relative overflow-hidden group" onClick={() => sceneImgRef.current.click()}>
                                            {sceneImg ? <img src={sceneImg} className="absolute inset-0 w-full h-full object-cover" /> : <div className="text-center text-white/30 group-hover:text-white/50"><Clapperboard className="w-6 h-6 mx-auto mb-1" /><span className="text-[9px]">场景参考图</span></div>}
                                            <input type="file" ref={sceneImgRef} onChange={e => handleImgUpload(e, setSceneImg)} className="hidden" accept="image/*" />
                                        </div>
                                    </div>
                                </div>

                                {/* 2. API 配置 (带状态灯) */}
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center">
                                        <div className="text-[10px] font-bold text-purple-300 uppercase flex items-center gap-1"><BrainCircuit className="w-3 h-3" /> Step 2: AI Config</div>
                                        <button onClick={() => setShowApiSettings(!showApiSettings)} className="text-[10px] text-white/50 hover:text-white underline">Settings</button>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <select value={provider} onChange={e => setProvider(e.target.value)} className="flex-1 bg-black/40 border border-purple-500/30 rounded-lg px-2 py-2 text-white text-xs focus:outline-none">
                                            <option value="offline">离线模式 (Rule-based)</option>
                                            <option value="siliconflow">SiliconFlow (DS-V3)</option>
                                            <option value="zhipu">智谱 AI (GLM-4)</option>
                                            <option value="deepseek">DeepSeek (Official)</option>
                                        </select>
                                        {/* 检测按钮 */}
                                        {provider !== 'offline' && (
                                            <button onClick={() => testConnection(provider)} disabled={apiStatus.loading} className={`px-3 rounded-lg border flex items-center gap-1 transition-all ${apiStatus.success === true ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300' : apiStatus.success === false ? 'bg-rose-500/20 border-rose-500/50 text-rose-300' : 'bg-white/5 border-white/10 text-white/50 hover:text-white'}`}>
                                                {apiStatus.loading ? <div className="w-3 h-3 border border-current rounded-full animate-spin"></div> : <Zap className="w-3 h-3" />}
                                            </button>
                                        )}
                                    </div>
                                    {/* 报错/成功信息 */}
                                    {apiStatus.msg && <div className={`text-[10px] px-1 ${apiStatus.success ? 'text-emerald-400' : 'text-rose-400'}`}>{apiStatus.msg}</div>}

                                    {/* 折叠的Key输入框 */}
                                    {showApiSettings && (
                                        <div className="p-3 bg-white/5 rounded-lg border border-white/10 space-y-2 animate-[fadeIn_0.2s]">
                                            <input type="password" value={siliconFlowKey} onChange={e => setSiliconFlowKey(e.target.value)} placeholder="SiliconFlow Key (sk-...)" className="w-full bg-black/60 border border-white/10 rounded px-2 py-1 text-[10px] text-white focus:border-purple-500" />
                                            <input type="password" value={zhipuKey} onChange={e => setZhipuKey(e.target.value)} placeholder="Zhipu Key (id.secret)" className="w-full bg-black/60 border border-white/10 rounded px-2 py-1 text-[10px] text-white focus:border-purple-500" />
                                            <input type="password" value={deepseekKey} onChange={e => setDeepseekKey(e.target.value)} placeholder="DeepSeek Key (sk-...)" className="w-full bg-black/60 border border-white/10 rounded px-2 py-1 text-[10px] text-white focus:border-purple-500" />
                                            <p className="text-[9px] text-white/30">* 仅存储在本地浏览器，不会上传服务器。</p>
                                        </div>
                                    )}
                                </div>

                                {/* 3. 剧本输入 & 执行 */}
                                <div className="flex-1 flex flex-col gap-2">
                                    <div className="flex justify-between items-center">
                                        <div className="text-[10px] font-bold text-pink-300 uppercase flex items-center gap-1"><FileText className="w-3 h-3" /> Step 3: Script Input</div>
                                        <div>
                                            <input type="file" ref={fileInputRef} className="hidden" accept=".docx,.txt" onChange={handleFileUpload} />
                                            <button onClick={() => fileInputRef.current.click()} className="text-[9px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-white transition-colors">Import File</button>
                                        </div>
                                    </div>
                                    <textarea 
                                        value={rawInput} 
                                        onChange={e => setRawInput(e.target.value)} 
                                        placeholder="在此输入或导入剧本内容... (例如: 银发少女在雨中奔跑，神情绝望...)" 
                                        className="flex-1 w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white text-sm focus:outline-none focus:border-purple-400 transition-all placeholder-white/20 resize-none font-mono leading-relaxed"
                                    />
                                    <button 
                                        onClick={handleAiPolish}
                                        disabled={isAiProcessing}
                                        className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-50 transition-all shadow-lg active:scale-95"
                                    >
                                        {isAiProcessing ? <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Sparkles className="w-4 h-4" />}
                                        START AUTO-DIRECTOR (开始分镜)
                                    </button>
                                </div>
                                
                                {/* 4. AI Chat Assistant for Prompt Improvement */}
                                <div className="bg-black/20 border border-white/10 rounded-xl p-4 flex flex-col">
                                    <div className="text-[10px] font-bold text-blue-300 uppercase flex items-center gap-1 mb-2">
                                        <Sparkles className="w-3 h-3" /> AI Prompt Assistant
                                    </div>
                                    <div className="text-[9px] text-white/60 mb-3">与AI对话优化提示词，改善生成效果</div>
                                    
                                    {/* Chat Messages Container */}
                                    <div className="flex-1 min-h-[120px] max-h-40 bg-black/30 rounded-lg p-3 mb-2 overflow-y-auto custom-scrollbar space-y-2">
                                        {chatMessages.length === 0 ? (
                                            <div className="text-[9px] text-white/40 h-full flex items-center justify-center">
                                                开始与AI助手对话，获取提示词优化建议...
                                            </div>
                                        ) : (
                                            chatMessages.map((msg) => (
                                                <div 
                                                    key={msg.id} 
                                                    className={`text-[9px] p-2 rounded-lg max-w-full ${
                                                        msg.role === 'user' 
                                                            ? 'bg-purple-500/20 text-purple-200 ml-auto' 
                                                            : 'bg-blue-500/10 text-blue-200 mr-auto'
                                                    }`}
                                                >
                                                    {msg.content}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    
                                    {/* Chat Input Area */}
                                    <div className="flex gap-1">
                                        <textarea
                                            value={chatInput}
                                            onChange={(e) => setChatInput(e.target.value)}
                                            onKeyDown={handleChatKeyPress}
                                            placeholder="向AI询问提示词优化技巧..."
                                            className="flex-1 bg-black/40 border border-white/10 rounded-lg px-2 py-1.5 text-[9px] text-white focus:outline-none focus:border-purple-400 resize-none h-10"
                                            rows="1"
                                        />
                                        <button
                                            onClick={sendChatMessage}
                                            disabled={isChatLoading}
                                            className="bg-purple-600 hover:bg-purple-500 disabled:opacity-50 text-white rounded-lg px-3 flex items-center transition-all"
                                        >
                                            {isChatLoading ? (
                                                <div className="w-3 h-3 border border-white/30 border-t-white rounded-full animate-spin"></div>
                                            ) : (
                                                <Send className="w-3 h-3" />
                                            )}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Right Column: Results Display */}
                            <div className="w-full md:w-2/3 bg-[#050505] p-6 flex flex-col relative">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="text-xs text-white/40 uppercase font-bold">Generated Shot List ({shots.length})</div>
                                    <button onClick={copyToClipboard} className="text-[10px] bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded text-white flex items-center gap-1 transition-all"><Copy className="w-3 h-3" /> Copy All</button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2 pb-20">
                                    {shots.length === 0 && !isAiProcessing && (
                                        <div className="h-full flex flex-col items-center justify-center text-white/20 select-none pointer-events-none">
                                            <Clapperboard className="w-16 h-16 mb-4 opacity-20" />
                                            <p className="text-sm font-mono">Waiting for Script Input...</p>
                                            <p className="text-xs opacity-50 mt-2">Ready to generate standardized prompts</p>
                                        </div>
                                    )}
                                    
                                    {shots.map((shot, index) => {
                                        const faceAllowed = canHaveFace(shot.angle, shot.shotSize);
                                        // 动态计算是否显示面部输入框（仅作展示，实际prompt已处理）
                                        return (
                                            <div key={shot.id} className="bg-white/5 border border-white/10 rounded-xl p-4 relative group hover:border-purple-500/30 transition-all">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center gap-2">
                                                        <span className="w-6 h-6 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center font-bold text-xs">{index + 1}</span>
                                                        <span className="text-xs text-white/60 font-mono">Shot {index + 1}</span>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        {/* Read-only tags based on AI generation */}
                                                        <span className="text-[9px] border border-cyan-500/30 text-cyan-300 px-1.5 py-0.5 rounded">{shot.angle}</span>
                                                        <span className="text-[9px] border border-pink-500/30 text-pink-300 px-1.5 py-0.5 rounded">{shot.shotSize}</span>
                                                        <span className="text-[9px] border border-yellow-500/30 text-yellow-300 px-1.5 py-0.5 rounded">{shot.cameraMove}</span>
                                                    </div>
                                                </div>
                                                
                                                {/* Prompt Preview Block */}
                                                <div className="bg-black/40 rounded-lg p-3 border border-white/5 font-mono text-sm text-gray-300 break-words leading-relaxed select-all">
                                                    {generatePrompt(shot)}
                                                </div>
                                                
                                                {/* Quick Delete */}
                                                <button 
                                                    onClick={() => removeShot(shot.id)} 
                                                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 p-1.5 text-white/20 hover:text-rose-400 transition-all"
                                                >
                                                    <Trash2 className="w-3 h-3" />
                                                </button>
                                            </div>
                                        )
                                    })}
                                </div>
                                
                                {/* Bottom Action Bar (Fixed) */}
                                {shots.length > 0 && (
                                    <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-[#050505] to-transparent flex justify-center">
                                        <button onClick={addShot} className="bg-white/10 hover:bg-white/20 border border-white/10 text-white text-xs px-6 py-2 rounded-full backdrop-blur-md transition-all">
                                            + Add Manual Shot
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Component (Complete) ---
        function App() {
            const [records, setRecords] = useState([]);
            const [dateStr, setDateStr] = useState(() => new Date().toISOString().split('T')[0]);
            const [remainingPoints, setRemainingPoints] = useState('');
            const [myShots, setMyShots] = useState('');
            const [partnerShots, setPartnerShots] = useState('');
            const [scriptName, setScriptName] = useState('');
            const [isTopUp, setIsTopUp] = useState(false);
            const [showDanger, setShowDanger] = useState(false);
            
            const [editingRecord, setEditingRecord] = useState(null);
            const [activeDetail, setActiveDetail] = useState(null);
            const [showGame, setShowGame] = useState(false);
            const [showDirector, setShowDirector] = useState(false);
            
            const [baseEfficiency, setBaseEfficiency] = useState(60); 
            const [triggerThreshold, setTriggerThreshold] = useState(1000);

            useEffect(() => {
                const saved = localStorage.getItem('render_tracker_data');
                if (saved) {
                    try { setRecords(JSON.parse(saved)); } catch (e) { console.error("Failed to load", e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('render_tracker_data', JSON.stringify(records));
            }, [records]);

            const lastRecord = records.length > 0 ? records[0] : null;
            const totalShots = (parseInt(myShots) || 0) + (parseInt(partnerShots) || 0);

            const efficiencyStreak = useMemo(() => {
                let streak = 0;
                for (const r of records) {
                    if (r.type === 'normal') {
                        if (!r.isInefficient) {
                            streak++;
                        } else {
                            break;
                        }
                    }
                }
                return streak;
            }, [records]);

            const handleAdd = () => {
                if (!remainingPoints) return;
                const currentPoints = parseInt(remainingPoints);
                const shots = totalShots; 
                const displayDate = dateStr.replace(/-/g, '/');
                
                let consumed = 0;
                let type = 'normal';

                if (!lastRecord) {
                    type = 'initial';
                    consumed = 0;
                } else if (isTopUp) {
                    type = 'topup';
                    consumed = 0;
                } else {
                    consumed = lastRecord.remaining - currentPoints;
                }

                const currentCPR = shots > 0 ? (consumed / shots) : 0;
                const isInefficient = type === 'normal' && consumed > triggerThreshold && (shots === 0 || currentCPR > baseEfficiency);

                const newRecord = {
                    id: Date.now(),
                    date: displayDate,
                    timestamp: new Date(dateStr).toISOString(),
                    remaining: currentPoints,
                    consumed: consumed,
                    shots: shots,
                    myShots: parseInt(myShots) || 0,
                    partnerShots: parseInt(partnerShots) || 0,
                    scriptName: scriptName,
                    type: type,
                    isInefficient: isInefficient,
                    cpr: currentCPR.toFixed(1)
                };
                setRecords([newRecord, ...records]);
                setRemainingPoints('');
                setMyShots('');
                setPartnerShots('');
                setScriptName('');
                setIsTopUp(false);
            };

            const handleDelete = (id) => setRecords(records.filter(r => r.id !== id));
            
            const handleUpdateRecord = (updatedRecord) => {
                setRecords(records.map(r => r.id === updatedRecord.id ? updatedRecord : r));
                setEditingRecord(null);
            };

            const clearAll = () => {
                if (confirm("确定要清空所有数据吗？这操作不可逆啊哥们。")) setRecords([]);
            };

            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "vidu_tracker_data.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const stats = useMemo(() => {
                const normalRecords = records.filter(r => r.type === 'normal');
                const totalConsumed = normalRecords.reduce((acc, curr) => acc + curr.consumed, 0);
                const totalShots = normalRecords.reduce((acc, curr) => acc + curr.shots, 0);
                const avgCPR = totalShots > 0 ? (totalConsumed / totalShots).toFixed(1) : 0;
                const inefficiencyCount = records.filter(r => r.isInefficient).length;
                const uniqueScripts = new Set(normalRecords.map(r => r.scriptName).filter(Boolean)).size;
                return { totalConsumed, totalShots, avgCPR, inefficiencyCount, uniqueScripts };
            }, [records]);

            const previewConsumption = lastRecord && !isTopUp && remainingPoints 
                ? (lastRecord.remaining - parseInt(remainingPoints)) 
                : null;

            const previewCPR = (!isTopUp && previewConsumption && totalShots > 0) 
                ? (previewConsumption / totalShots).toFixed(1) 
                : null;

            return (
                <div className="min-h-screen relative p-4 md:p-8 font-sans selection:bg-pink-500/30 selection:text-white">
                    {/* Background */}
                    <div className="fixed inset-0 -z-10 pointer-events-none bg-[#050505] overflow-hidden">
                        <div className="absolute w-[60vw] h-[60vw] bg-purple-600/20 rounded-full blur-[120px] mix-blend-screen animate-[aurora-1_15s_infinite_alternate]"></div>
                        <div className="absolute w-[50vw] h-[50vw] bg-cyan-500/20 rounded-full blur-[100px] mix-blend-screen animate-[aurora-2_20s_infinite_alternate]"></div>
                        <div className="absolute w-[40vw] h-[40vw] bg-pink-500/20 rounded-full blur-[90px] mix-blend-screen animate-[aurora-3_12s_infinite_alternate]"></div>
                        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 mix-blend-overlay"></div>
                    </div>

                    {/* Modals */}
                    {showDanger && (
                      <div className="fixed inset-0 z-[100] bg-red-600 flex items-center justify-center cursor-pointer animate-[extreme-shake_0.5s_infinite]" onClick={() => setShowDanger(false)}>
                        <div className="flex flex-col items-center gap-12">
                           <h1 className="text-[15rem] md:text-[20rem] font-black text-black leading-none select-none flex flex-col items-center drop-shadow-[10px_10px_0_rgba(255,255,255,0.2)]"><span>快</span><span>跑</span></h1>
                        </div>
                      </div>
                    )}
                    {showGame && <GameModal onClose={() => setShowGame(false)} />}
                    {showDirector && <DirectorModal onClose={() => setShowDirector(false)} />}
                    {editingRecord && <EditModal record={editingRecord} onClose={() => setEditingRecord(null)} onSave={handleUpdateRecord} baseEfficiency={baseEfficiency} />}
                    {activeDetail && <DetailModal title={activeDetail === 'consumption' ? '每日算力消耗明细' : activeDetail === 'shots' ? '每日产出 (我 vs 队友)' : activeDetail === 'cpr' ? '每日 CPR 效率走势' : activeDetail === 'scripts' ? '剧本效益审计面板' : '低效警告记录'} type={activeDetail} data={records} onClose={() => setActiveDetail(null)} baseEfficiency={baseEfficiency} />}

                    <div className="max-w-6xl mx-auto space-y-8 relative z-10">
                        {/* Header */}
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative">
                            <div>
                                <h1 className="text-3xl md:text-4xl font-black tracking-tighter flex flex-col md:flex-row md:items-center gap-3 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                                    <span className="bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 via-purple-300 to-pink-300 animate-pulse">Vidu-ai 视频抽卡</span>
                                    <span className="text-white text-xl md:text-2xl font-bold flex items-center gap-2">积分消耗计算平台<div className="flex flex-col items-start"><span className="text-xs bg-white/10 text-white px-2 py-0.5 rounded border border-white/20 tracking-widest uppercase backdrop-blur-md">易专属</span><span className="text-[9px] text-white/40 scale-90 origin-left mt-0.5 tracking-wider font-normal">南昌酱油公司</span></div></span>
                                </h1>
                                <p className="text-white/40 text-sm mt-2 font-medium tracking-wide flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>System Online · 七彩高斯引擎渲染中</p>
                            </div>
                            <div className="hidden lg:flex absolute left-1/2 ml-[113px] top-1/2 -translate-x-1/2 -translate-y-1/2 flex-col items-center justify-center cursor-pointer group z-20 hover:scale-110 transition-transform duration-300" onClick={() => setShowDanger(true)}>
                                <AlertTriangle className="w-20 h-20 text-red-600 animate-pulse drop-shadow-[0_0_35px_rgba(220,38,38,1)]" />
                                <span className="text-red-600 font-black text-[10px] tracking-[0.2em] mt-1 bg-black/80 px-4 py-2 rounded border border-red-600/80 backdrop-blur-md shadow-[0_0_15px_rgba(220,38,38,0.6)] whitespace-nowrap opacity-100">危险！！禁止打开！！</span>
                            </div>
                            <div className="flex items-center gap-3 relative z-10">
                                {efficiencyStreak > 0 && <div className="hidden md:flex items-center gap-2 bg-gradient-to-r from-orange-500/20 to-red-500/20 border border-orange-500/30 px-3 py-2 rounded-full backdrop-blur-md animate-[pulse-glow_2s_infinite]"><Flame className="w-4 h-4 text-orange-400" /><span className="text-xs font-bold text-orange-200">{efficiencyStreak} Days Efficient</span></div>}
                                <button onClick={() => setShowGame(true)} className="bg-white/5 hover:bg-white/10 border border-white/10 p-3 rounded-full transition-all hover:scale-110 hover:shadow-[0_0_15px_rgba(255,255,255,0.3)] group" title="Play Neural Gacha"><Gamepad2 className="w-5 h-5 text-purple-300 group-hover:text-purple-100" /></button>
                                <div className="hidden md:flex gap-4 text-xs font-bold text-white/80 bg-white/5 backdrop-blur-md border border-white/10 px-5 py-3 rounded-full shadow-lg">
                                    <div className="flex items-center gap-2"><div className="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_10px_#34d399]"></div><span className="text-emerald-300">Target &lt; {baseEfficiency}</span></div>
                                    <div className="w-px h-4 bg-white/10"></div>
                                    <div className="flex items-center gap-2"><div className="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_10px_#f43f5e]"></div><span className="text-rose-400">Alert &gt; {baseEfficiency}</span></div>
                                </div>
                            </div>
                        </div>

                        {/* Stats - Now 6 Cards (5 Data + 1 Director Tool) */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            {[
                                { id: 'consumption', label: "算力总消耗", value: stats.totalConsumed.toLocaleString(), icon: TrendingDown, color: "text-white" },
                                { id: 'shots', label: "总生成镜头", value: stats.totalShots, icon: Users, color: "text-cyan-300" },
                                { id: 'cpr', label: "平均 CPR", value: stats.avgCPR, sub: "分/镜", icon: BarChart2, color: parseFloat(stats.avgCPR) > baseEfficiency ? "text-rose-400 drop-shadow-[0_0_8px_rgba(244,63,94,0.6)]" : "text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.6)]" },
                                { id: 'inefficiency', label: "低效警告", value: stats.inefficiencyCount, icon: AlertTriangle, color: stats.inefficiencyCount > 0 ? "text-rose-500" : "text-emerald-500" },
                                { id: 'scripts', label: "活跃剧本", value: stats.uniqueScripts, icon: Clapperboard, color: "text-indigo-400", sub: "Projects" },
                                // New Director Card
                                { id: 'director', label: "提示词导演", value: "OPEN", icon: Wand2, color: "text-purple-400", sub: "Tool", action: true }
                            ].map((item, idx) => (
                                <Card key={idx} onClick={() => item.action ? setShowDirector(true) : setActiveDetail(item.id)} className="group">
                                    <div className="text-white/40 text-[10px] uppercase tracking-widest font-bold mb-3 flex items-center justify-between">
                                        <div className="flex items-center gap-2"><item.icon className="w-3.5 h-3.5" /> {item.label}</div>
                                        <ChevronRight className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </div>
                                    <div className={`text-2xl md:text-3xl font-mono font-bold ${item.color}`}>
                                        {item.value}
                                    </div>
                                    {item.sub && <div className="text-[10px] text-white/20 mt-1 font-medium">{item.sub}</div>}
                                </Card>
                            ))}
                        </div>

                        {/* Input Section (Keeping existing code...) */}
                        <Card className="!bg-white/5 !border-white/10 shadow-[0_0_50px_-20px_rgba(255,255,255,0.1)]">
                            <div className="flex flex-col gap-6">
                                <div className="flex justify-between items-center border-b border-white/5 pb-4">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                        <PlusCircle className="w-5 h-5 text-cyan-400" />
                                        数据录入终端
                                    </h2>
                                    {lastRecord && (
                                        <span className="text-xs font-mono font-bold text-cyan-200/70 bg-white/5 px-3 py-1.5 rounded border border-white/10">
                                            LAST: {lastRecord.remaining}
                                        </span>
                                    )}
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-12 gap-5 items-end">
                                    <div className="md:col-span-12 flex items-center gap-3 mb-1">
                                        <label className="group flex items-center gap-3 cursor-pointer select-none">
                                            <div className={`w-12 h-6 rounded-full p-1 transition-all duration-300 ${isTopUp ? 'bg-emerald-500/80' : 'bg-white/10'}`} onClick={() => setIsTopUp(!isTopUp)}>
                                                <div className={`w-4 h-4 rounded-full bg-white shadow-md transform transition-all duration-300 ${isTopUp ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                            </div>
                                            <span className={`text-xs font-bold uppercase tracking-wide transition-colors ${isTopUp ? 'text-emerald-400' : 'text-slate-500 group-hover:text-slate-400'}`}>{isTopUp ? "RECHARGE MODE" : "AUDIT MODE"}</span>
                                        </label>
                                    </div>
                                    
                                    <div className="md:col-span-3 relative group">
                                        <label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-white transition-colors">Date</label>
                                        <input type="date" value={dateStr} onChange={(e) => setDateStr(e.target.value)} className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-white/30 focus:bg-black/40 transition-all font-mono text-lg" />
                                    </div>

                                    <div className="md:col-span-3 relative group">
                                        <label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-white transition-colors">Balance</label>
                                        <input type="number" value={remainingPoints} onChange={(e) => setRemainingPoints(e.target.value)} placeholder="0" className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-white/30 focus:bg-black/40 transition-all font-mono text-lg" />
                                    </div>

                                    <div className="md:col-span-6 relative group">
                                        <label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-indigo-400 transition-colors">Script Name (剧本)</label>
                                        <input type="text" value={scriptName} onChange={(e) => setScriptName(e.target.value)} placeholder="e.g. Star Wars V" disabled={isTopUp} className={`w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-indigo-500/50 focus:bg-black/40 transition-all font-mono text-lg ${isTopUp ? 'opacity-20 cursor-not-allowed' : ''}`} />
                                    </div>

                                    <div className="md:col-span-4 relative group">
                                        <label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-cyan-400 transition-colors">My Shots</label>
                                        <input type="number" value={myShots} onChange={(e) => setMyShots(e.target.value)} placeholder="Me" disabled={isTopUp} className={`w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-cyan-500/50 focus:bg-black/40 transition-all font-mono text-lg ${isTopUp ? 'opacity-20 cursor-not-allowed' : ''}`} />
                                    </div>

                                    <div className="md:col-span-4 relative group">
                                        <label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-pink-400 transition-colors">Partner</label>
                                        <input type="number" value={partnerShots} onChange={(e) => setPartnerShots(e.target.value)} placeholder="Ta" disabled={isTopUp} className={`w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-pink-500/50 focus:bg-black/40 transition-all font-mono text-lg ${isTopUp ? 'opacity-20 cursor-not-allowed' : ''}`} />
                                    </div>

                                    <div className="md:col-span-4">
                                        <button onClick={handleAdd} disabled={!remainingPoints} className="w-full h-[52px] bg-white/10 hover:bg-white/20 disabled:bg-black/20 disabled:text-white/20 disabled:cursor-not-allowed text-white font-bold rounded-lg transition-all border border-white/10 active:scale-95 flex items-center justify-center gap-2 group">
                                            <Save className="w-4 h-4 group-hover:scale-110 transition-transform" />
                                            <span>COMMIT</span>
                                        </button>
                                    </div>
                                </div>

                                {!isTopUp && previewConsumption !== null && (
                                    <div className={`mt-2 rounded-lg p-4 text-center border backdrop-blur-md transition-all animate-pulse ${previewConsumption > triggerThreshold && previewCPR > baseEfficiency ? 'bg-rose-500/10 border-rose-500/20' : 'bg-white/5 border-white/10'}`}>
                                        <div className="flex justify-center items-center gap-8">
                                            <div><span className="text-white/30 text-[10px] uppercase font-bold tracking-widest block mb-1">Cost</span><div className={`font-mono font-bold text-xl text-white`}>{previewConsumption}</div></div>
                                            {previewCPR && (<>
                                                <div className="w-px h-8 bg-white/10"></div>
                                                <div><span className="text-white/30 text-[10px] uppercase font-bold tracking-widest block mb-1">CPR</span><div className={`font-mono font-bold text-xl flex items-center gap-1 ${parseFloat(previewCPR) > baseEfficiency ? 'text-rose-400' : 'text-emerald-400'}`}>{previewCPR}</div></div>
                                            </>)}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </Card>

                        {/* History List */}
                        <div className="space-y-5">
                            <div className="flex justify-between items-end px-2 border-b border-white/5 pb-2">
                                <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                    <History className="w-4 h-4 text-cyan-500" />
                                    LOGS
                                </h2>
                                <div className="flex gap-3">
                                    <button onClick={exportData} className="flex items-center gap-1 text-[10px] font-bold text-white/40 hover:text-cyan-400 transition-colors uppercase tracking-wider">
                                        <Download className="w-3 h-3" /> Export
                                    </button>
                                    <button onClick={clearAll} className="text-[10px] font-bold text-white/40 hover:text-rose-400 transition-colors uppercase tracking-wider">
                                        Clear Data
                                    </button>
                                </div>
                            </div>

                            <div className="space-y-3">
                                {records.length === 0 ? (
                                    <div className="text-center py-16 text-white/20 bg-white/5 rounded-lg border border-dashed border-white/10"><p className="font-mono text-sm">NO DATA DETECTED</p></div>
                                ) : (
                                    records.map((record) => (
                                        <div key={record.id} className={`group relative backdrop-blur-md bg-white/5 border border-white/5 hover:bg-white/10 rounded-lg p-4 transition-all duration-300 hover:border-white/10 ${record.isInefficient ? 'shadow-[inset_2px_0_0_0_#f43f5e]' : record.type === 'topup' ? 'shadow-[inset_2px_0_0_0_#10b981]' : 'shadow-[inset_2px_0_0_0_#6366f1]'}`}>
                                            <div className="flex justify-between items-center">
                                                <div className="flex flex-col gap-2">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-white/60 text-xs font-mono">{record.date}</span>
                                                        {record.type === 'topup' && <Badge type="success">RECHARGE</Badge>}
                                                        {record.type === 'initial' && <Badge type="neutral">INIT</Badge>}
                                                        {record.isInefficient && <Badge type="danger">INEFFICIENT</Badge>}
                                                        {/* 显示剧本名字 */}
                                                        {record.scriptName && <Badge type="script">{record.scriptName}</Badge>}
                                                    </div>
                                                    <div className="flex items-center gap-4 md:gap-8 mt-1">
                                                        <div className="flex flex-col"><span className="text-[10px] text-white/20 uppercase font-bold">Balance</span><span className="text-white/80 font-mono">{record.remaining}</span></div>
                                                        {record.type === 'normal' && (
                                                            <>
                                                                <div className="w-px h-6 bg-white/5"></div>
                                                                <div className="flex flex-col"><span className="text-[10px] text-white/20 uppercase font-bold">Cost</span><span className="text-white font-bold font-mono">{record.consumed}</span></div>
                                                                <div className="w-px h-6 bg-white/5"></div>
                                                                <div className="flex flex-col">
                                                                    <span className="text-[10px] text-white/20 uppercase font-bold">Shots</span>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-cyan-300 font-mono">{record.shots}</span>
                                                                        {(record.myShots !== undefined || record.partnerShots !== undefined) && (<span className="text-[10px] text-white/30 font-mono">{record.myShots}+{record.partnerShots}</span>)}
                                                                    </div>
                                                                </div>
                                                                {record.shots > 0 && (
                                                                    <div className={`ml-auto hidden md:flex flex-col items-end px-3 py-1 rounded border ${parseFloat(record.cpr) > baseEfficiency ? 'bg-rose-500/10 border-rose-500/20' : 'bg-emerald-500/10 border-emerald-500/20'}`}>
                                                                        <span className={`text-[10px] uppercase font-bold ${parseFloat(record.cpr) > baseEfficiency ? 'text-rose-500' : 'text-emerald-500'}`}>CPR</span>
                                                                        <span className={`font-mono text-sm ${parseFloat(record.cpr) > baseEfficiency ? 'text-rose-300' : 'text-emerald-300'}`}>{record.cpr}</span>
                                                                    </div>
                                                                )}
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => setEditingRecord(record)} className="p-2 text-white/20 hover:text-cyan-400 hover:bg-white/5 rounded transition-all"><Edit2 className="w-4 h-4" /></button>
                                                    <button onClick={() => handleDelete(record.id)} className="p-2 text-white/20 hover:text-rose-500 hover:bg-white/5 rounded transition-all"><Trash2 className="w-4 h-4" /></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
