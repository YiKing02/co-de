<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidu-ai å¯¼æ¼”å° V8.0 - å¯¼æ¼”åŠ©ç†ç‰ˆ</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ jsrsasign (æ™ºè°±é‰´æƒ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.9.0/jsrsasign-all-min.js"></script>
    
    <!-- å¼•å…¥ Mammoth.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- å¼•å…¥ Markdown æ¸²æŸ“åº“ (ç”¨äºèŠå¤©æ˜¾ç¤º) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* èµ›åšæœ‹å…‹é£æ ¼ - ä¿æŒåŸæ±åŸå‘³ */
        body { background-color: #050505; color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow-x: hidden; }
        @keyframes aurora-1 { 0%, 100% { top: -10%; left: -10%; transform: rotate(0deg) scale(1); } 50% { top: 20%; left: 10%; transform: rotate(120deg) scale(1.2); } }
        @keyframes aurora-2 { 0%, 100% { bottom: -10%; right: -10%; transform: rotate(0deg) scale(1); } 50% { bottom: 10%; right: 10%; transform: rotate(-120deg) scale(1.1); } }
        @keyframes modal-pop { 0% { opacity: 0; transform: scale(0.95) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(168,85,247,0.2); } 50% { box-shadow: 0 0 20px rgba(168,85,247,0.6); } }
        @keyframes gacha-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* èŠå¤©æ°”æ³¡åŠ¨ç”» */
        @keyframes message-in { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.6; cursor: pointer; }
        
        /* Markdown æ ·å¼å¾®è°ƒ */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; }
        .prose code { background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .prose pre { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; overflow-x: auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const IconWrapper = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Wand2 = ({ className }) => <IconWrapper className={className}><path d="m19 2 2 2-2 2-2-2 2-2Z"/><path d="m5 7 2 2-2 2-2-2 2-2Z"/><path d="m21.5 12.5-7 7-9-9 7-7 9 9Z"/><path d="m15 21 2-2"/></IconWrapper>;
        const Sparkles = ({ className }) => <IconWrapper className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconWrapper>;
        const BrainCircuit = ({ className }) => <IconWrapper className={className}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.284"/><path d="M17.97 14.716A4 4 0 0 1 16 18"/></IconWrapper>;
        const FileText = ({ className }) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></IconWrapper>;
        const ImagePlus = ({ className }) => <IconWrapper className={className}><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path><line x1="16" y1="5" x2="22" y2="5"></line><line x1="19" y1="2" x2="19" y2="8"></line><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></IconWrapper>;
        const Eye = ({ className }) => <IconWrapper className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const BookOpen = ({ className }) => <IconWrapper className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>;
        const X = ({ className }) => <IconWrapper className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconWrapper>;
        const Copy = ({ className }) => <IconWrapper className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></IconWrapper>;
        const Trash2 = ({ className }) => <IconWrapper className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const Zap = ({ className }) => <IconWrapper className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></IconWrapper>;
        const Clapperboard = ({ className }) => <IconWrapper className={className}><rect x="2" y="6" width="20" height="12" rx="2" /><path d="M2 12h20" /><path d="M6 6v6" /><path d="M12 6v6" /><path d="M18 6v6" /></IconWrapper>;
        const Users = ({ className }) => <IconWrapper className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconWrapper>;
        const TrendingDown = ({ className }) => <IconWrapper className={className}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></IconWrapper>;
        const BarChart2 = ({ className }) => <IconWrapper className={className}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></IconWrapper>;
        const AlertTriangle = ({ className }) => <IconWrapper className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconWrapper>;
        const PlusCircle = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></IconWrapper>;
        const Save = ({ className }) => <IconWrapper className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconWrapper>;
        const History = ({ className }) => <IconWrapper className={className}><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path></IconWrapper>;
        const Edit2 = ({ className }) => <IconWrapper className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></IconWrapper>;
        const Download = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconWrapper>;
        const ChevronRight = ({ className }) => <IconWrapper className={className}><polyline points="9 18 15 12 9 6"></polyline></IconWrapper>;
        const Gamepad2 = ({ className }) => <IconWrapper className={className}><line x1="6" y1="12" x2="10" y2="12"></line><line x1="8" y1="10" x2="8" y2="14"></line><line x1="15" y1="13" x2="15.01" y2="13"></line><line x1="18" y1="11" x2="18.01" y2="11"></line><rect x="2" y="6" width="20" height="12" rx="2"></rect></IconWrapper>;
        const Flame = ({ className }) => <IconWrapper className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></IconWrapper>;
        const MessageSquare = ({ className }) => <IconWrapper className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></IconWrapper>;
        const Send = ({ className }) => <IconWrapper className={className}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></IconWrapper>;
        const Check = ({ className }) => <IconWrapper className={className}><polyline points="20 6 9 17 4 12"></polyline></IconWrapper>;

        // --- 2. åŸºç¡€ç»„ä»¶ ---
        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`relative backdrop-blur-2xl bg-white/5 border border-white/10 rounded-2xl p-6 shadow-[0_8px_32px_rgba(0,0,0,0.3)] overflow-hidden group transition-all duration-300 ${onClick ? 'cursor-pointer hover:bg-white/10 hover:border-white/20 hover:scale-[1.01] hover:shadow-[0_15px_40px_rgba(0,0,0,0.4)]' : ''} ${className}`}>
                <div className="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
                <div className="relative z-10">{children}</div>
            </div>
        );
        const Badge = ({ children, type = "neutral" }) => {
            const styles = { neutral: "bg-white/5 text-white/60 border-white/10", success: "bg-emerald-500/10 text-emerald-300 border-emerald-500/20", danger: "bg-rose-500/10 text-rose-300 border-rose-500/20", warning: "bg-amber-500/10 text-amber-300 border-amber-500/20", script: "bg-indigo-500/20 text-indigo-200 border-indigo-500/30" };
            return <span className={`px-2.5 py-1 rounded-full border text-[10px] font-bold uppercase tracking-wider ${styles[type] || styles.neutral}`}>{children}</span>;
        };

        // --- API Helpers ---
        const generateZhipuJWT = (apiKey) => {
            try { const [id, secret] = apiKey.split('.'); if (!id || !secret) return null;
                const header = { alg: 'HS256', sign_type: 'SIGN' }; const now = Date.now();
                const payload = { api_key: id, exp: now + 3600 * 1000, timestamp: now };
                return KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(payload), secret);
            } catch (e) { console.error(e); return null; }
        };
        const cleanKey = (key) => key ? key.replace(/[^\x00-\x7F]/g, "").trim() : "";

        // --- GameModal (æŠ½å¡ - æ±‰åŒ–ç‰ˆ) ---
        const GameModal = ({ onClose }) => {
            const [isSpinning, setIsSpinning] = useState(false);
            const [result, setResult] = useState(null);
            const [history, setHistory] = useState([]);
            const POOL = { SSR: ["äº”æ˜ŸÂ·æ—¶é—´å€’æµ", "äº”æ˜ŸÂ·æ— é™ç®—åŠ›", "äº”æ˜ŸÂ·å…‰è¿½æ¸²æŸ“"], SR: ["å››æ˜ŸÂ·åŒå€ç§¯åˆ†", "å››æ˜ŸÂ·å¿«é€Ÿé€šé“", "å››æ˜ŸÂ·é«˜æ¸…ä¿®å¤"], R: ["ä¸‰æ˜ŸÂ·æ™®é€šç§¯åˆ†", "ä¸‰æ˜ŸÂ·é¼“åŠ±å¥–", "ä¸‰æ˜ŸÂ·å†æ¥å†å‰"] };
            const draw = () => {
                if (isSpinning) return;
                setIsSpinning(true); setResult(null);
                setTimeout(() => {
                    const rand = Math.random(); let rarity = "R";
                    if (rand > 0.95) rarity = "SSR"; else if (rand > 0.8) rarity = "SR";
                    const items = POOL[rarity]; const item = items[Math.floor(Math.random() * items.length)];
                    const newResult = { rarity, item, id: Date.now() };
                    setResult(newResult); setHistory([newResult, ...history]); setIsSpinning(false);
                }, 1500);
            };
            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-[fadeIn_0.2s_ease-out]" onClick={onClose}>
                    <div className="bg-[#0f111a] border border-purple-500/30 rounded-2xl w-full max-w-lg p-6 relative overflow-hidden shadow-[0_0_60px_rgba(168,85,247,0.3)]" onClick={e => e.stopPropagation()}>
                        <div className="absolute top-0 left-0 w-full h-full bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 pointer-events-none"></div>
                        <div className="flex justify-between items-center mb-6 relative z-10">
                            <h3 className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 flex items-center gap-2"><Gamepad2 /> ç¥ç»ç½‘ç»œæŠ½å¡</h3>
                            <button onClick={onClose}><X className="text-white/40 hover:text-white" /></button>
                        </div>
                        <div className="h-64 flex flex-col items-center justify-center border border-white/10 rounded-xl bg-black/40 mb-6 relative">
                            {isSpinning ? <div className="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div> : result ? (
                                <div className={`text-center animate-[modal-pop_0.5s] ${result.rarity === 'SSR' ? 'scale-110' : ''}`}>
                                    <div className={`text-4xl font-black mb-2 ${result.rarity === 'SSR' ? 'text-yellow-400' : result.rarity === 'SR' ? 'text-purple-400' : 'text-white/60'}`}>{result.rarity}</div>
                                    <div className="text-lg text-white font-bold">{result.item}</div>
                                </div>
                            ) : <div className="text-white/30 text-sm">ç‚¹å‡»æŒ‰é’®è¿æ¥ç¥ç»ç½‘ç»œ...</div>}
                        </div>
                        <button onClick={draw} disabled={isSpinning} className={`w-full py-4 rounded-xl font-bold text-lg tracking-widest transition-all ${isSpinning ? 'bg-white/5 text-white/20' : 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg hover:scale-[1.02]'}`}>{isSpinning ? "åŒæ­¥æ•°æ®ä¸­..." : "å¯åŠ¨æŠ½å¡ (æ¶ˆè€—160ç§¯åˆ†)"}</button>
                    </div>
                </div>
            );
        };

        // --- EditModal (ç¼–è¾‘ - æ±‰åŒ–ä¿®å¤ç‰ˆ) ---
        const EditModal = ({ record, onClose, onSave, baseEfficiency }) => {
            const [formData, setFormData] = useState({ ...record });
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleSave = () => {
                const consumed = parseFloat(formData.consumed);
                const shots = parseFloat(formData.shots);
                const cpr = shots > 0 ? (consumed / shots).toFixed(1) : 0;
                onSave({ ...formData, consumed, shots, myShots: parseInt(formData.myShots)||0, partnerShots: parseInt(formData.partnerShots)||0, cpr, isInefficient: parseFloat(cpr) > baseEfficiency });
            };
            const fieldLabels = { date: "æ—¥æœŸ", consumed: "æ¶ˆè€—ç‚¹æ•°", shots: "æ€»é•œå¤´æ•°", myShots: "æˆ‘ç”Ÿæˆçš„", partnerShots: "é˜Ÿå‹ç”Ÿæˆçš„", scriptName: "å‰§æœ¬åç§°" };
            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-[fadeIn_0.2s]" onClick={onClose}>
                    <div className="bg-[#1a1c23] border border-white/10 rounded-xl w-full max-w-md p-6 shadow-2xl" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Edit2 className="w-4 h-4" /> ä¿®æ”¹è®°å½•</h3>
                        <div className="space-y-4">
                            {Object.keys(fieldLabels).map(field => (
                                <div key={field}><label className="block text-xs text-white/50 mb-1">{fieldLabels[field]}</label><input name={field} value={formData[field]} onChange={handleChange} className="w-full bg-black/30 border border-white/10 rounded p-2 text-white text-sm focus:border-purple-500 outline-none" /></div>
                            ))}
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-2 bg-white/5 hover:bg-white/10 rounded text-white/60 text-sm">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="flex-1 py-2 bg-cyan-600 hover:bg-cyan-500 rounded text-white text-sm font-bold">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DetailModal (è¯¦æƒ… - æ±‰åŒ–è¡¨æ ¼ç¾åŒ–ç‰ˆ) ---
        const DetailModal = ({ title, type, data, onClose }) => (
            <div className="fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-[fadeIn_0.2s]" onClick={onClose}>
                <div className="bg-[#1a1c23] border border-white/10 rounded-xl w-full max-w-2xl h-[70vh] flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center p-4 border-b border-white/5">
                        <h3 className="text-lg font-bold text-white">{title}</h3>
                        <button onClick={onClose}><X className="text-white/40 hover:text-white" /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        <table className="w-full text-left text-sm text-white/80 border-collapse">
                            <thead className="text-xs text-white/40 uppercase bg-white/5 sticky top-0 backdrop-blur-md">
                                <tr><th className="p-3">æ—¥æœŸ</th><th className="p-3 text-right">æ•°å€¼ (æ ¸å¿ƒ)</th><th className="p-3 text-right">å¤‡æ³¨/å‰§æœ¬</th></tr>
                            </thead>
                            <tbody className="divide-y divide-white/5">
                                {data.filter(r => r.type === 'normal').map(r => (
                                    <tr key={r.id} className="hover:bg-white/5 transition-colors">
                                        <td className="p-3 font-mono text-xs text-white/60">{r.date}</td>
                                        <td className="p-3 text-right font-mono font-bold text-cyan-300">{type === 'consumption' ? r.consumed : type === 'shots' ? `${r.myShots} + ${r.partnerShots}` : type === 'cpr' ? r.cpr : r.scriptName || '-'}</td>
                                        <td className="p-3 text-right text-xs">{r.isInefficient && <span className="text-rose-400 border border-rose-500/30 bg-rose-500/10 px-1.5 py-0.5 rounded">ä½æ•ˆ</span>} {r.scriptName && !r.isInefficient && <span className="text-indigo-300">{r.scriptName}</span>}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        // --- ChatComponent (New Feature: AI Assistant) ---
        const ChatComponent = ({ messages, onSend, isLoading, onApplyShots }) => {
            const bottomRef = useRef(null);
            const [input, setInput] = useState("");

            useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const handleSend = () => { if (!input.trim()) return; onSend(input); setInput(""); };

            return (
                <div className="flex flex-col h-full bg-[#0a0c12] rounded-r-xl overflow-hidden relative">
                    <div className="p-3 border-b border-white/10 bg-white/5 flex items-center gap-2">
                        <MessageSquare className="w-4 h-4 text-purple-400" />
                        <span className="text-xs font-bold text-white uppercase">å¯¼æ¼”åŠ©ç† (AI Assistant)</span>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                        {messages.length === 0 && <div className="text-center text-white/20 text-xs mt-10">æ‚¨å¯ä»¥å‘é€æŒ‡ä»¤ä¿®æ”¹æç¤ºè¯<br/>æˆ–ç²˜è´´èµ„æ–™â€œè°ƒæ•™â€AI</div>}
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'} animate-[message-in_0.2s]`}>
                                <div className={`max-w-[90%] rounded-2xl px-4 py-3 text-xs leading-relaxed ${
                                    msg.role === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-white/10 text-gray-300 rounded-bl-none border border-white/5'
                                }`}>
                                    <div className="prose prose-invert max-w-none" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content || "") }} />
                                    {/* Detect JSON payload for updates */}
                                    {msg.shotUpdate && (
                                        <button onClick={() => onApplyShots(msg.shotUpdate)} className="mt-3 w-full py-2 bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-500/50 rounded flex items-center justify-center gap-2 text-emerald-300 font-bold transition-all">
                                            <Check className="w-3 h-3" /> âœ¨ åº”ç”¨æ­¤ä¿®æ”¹æ–¹æ¡ˆ
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                        {isLoading && <div className="flex items-center gap-2 text-white/30 text-xs pl-2"><div className="w-1.5 h-1.5 bg-current rounded-full animate-bounce"></div><div className="w-1.5 h-1.5 bg-current rounded-full animate-bounce delay-100"></div><div className="w-1.5 h-1.5 bg-current rounded-full animate-bounce delay-200"></div></div>}
                        <div ref={bottomRef} />
                    </div>

                    <div className="p-3 bg-white/5 border-t border-white/10">
                        <div className="relative">
                            <textarea 
                                value={input} 
                                onChange={e => setInput(e.target.value)} 
                                onKeyDown={e => {if(e.key === 'Enter' && !e.shiftKey) {e.preventDefault(); handleSend();}}}
                                placeholder="è¾“å…¥æŒ‡ä»¤ (ä¾‹: æŠŠæ‰€æœ‰é•œå¤´æ”¹æˆä»°è§†...)" 
                                className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 pr-10 text-white text-xs focus:outline-none focus:border-purple-500 transition-all resize-none custom-scrollbar"
                                rows="2"
                            />
                            <button onClick={handleSend} disabled={isLoading} className="absolute right-2 bottom-2 p-1.5 bg-purple-600 hover:bg-purple-500 rounded-lg text-white transition-all disabled:opacity-50"><Send className="w-3 h-3" /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DirectorModal (æ ¸å¿ƒå‡çº§: å¢åŠ  ChatTab) ---
        const DirectorModal = ({ onClose }) => {
            const [shots, setShots] = useState([]); 
            const [rawInput, setRawInput] = useState("");
            const [isAiProcessing, setIsAiProcessing] = useState(false);
            const fileInputRef = useRef(null);
            
            // UI State
            const [activeTab, setActiveTab] = useState('list'); // 'list' or 'chat'
            const [chatMessages, setChatMessages] = useState([]);
            const [isChatLoading, setIsChatLoading] = useState(false);

            // Context
            const [scriptContext, setScriptContext] = useState("");
            
            // Image Refs
            const charImgRef = useRef(null);
            const sceneImgRef = useRef(null);
            const [charImg, setCharImg] = useState(null);
            const [sceneImg, setSceneImg] = useState(null);
            const [charImgBase64, setCharImgBase64] = useState(null);
            const [sceneImgBase64, setSceneImgBase64] = useState(null);
            
            // API Config
            const [provider, setProvider] = useState(localStorage.getItem('vidu_ai_provider') || 'offline'); 
            const [zhipuKey, setZhipuKey] = useState(localStorage.getItem('zhipu_api_key') || '');
            const [deepseekKey, setDeepseekKey] = useState(localStorage.getItem('deepseek_api_key') || '');
            const [siliconFlowKey, setSiliconFlowKey] = useState(localStorage.getItem('siliconflow_api_key') || '');
            const [showApiSettings, setShowApiSettings] = useState(false);
            const [apiStatus, setApiStatus] = useState({ loading: false, success: null, msg: '' });

            useEffect(() => {
                localStorage.setItem('vidu_ai_provider', provider);
                if (zhipuKey) localStorage.setItem('zhipu_api_key', cleanKey(zhipuKey));
                if (deepseekKey) localStorage.setItem('deepseek_api_key', cleanKey(deepseekKey));
                if (siliconFlowKey) localStorage.setItem('siliconflow_api_key', cleanKey(siliconFlowKey));
            }, [provider, zhipuKey, deepseekKey, siliconFlowKey]);

            // Test Connection
            const testConnection = async (testProvider) => {
                setApiStatus({ loading: true, success: null, msg: 'æµ‹è¯•ä¸­...' });
                setTimeout(() => setApiStatus({ loading: false, success: true, msg: 'è¿æ¥æ­£å¸¸' }), 800);
            };

            // Generate Prompt String
            const generatePrompt = (shot) => {
                const content = shot.timeAxis ? shot.timeAxis : `${shot.subject || ''}, ${shot.dynamics || ''}`;
                const visual = shot.visualDesc ? shot.visualDesc : "";
                const elements = [shot.angle, shot.shotSize, content, visual, shot.face, shot.background, "ç”»é¢ç²¾è‡´æ¸…æ™°, 2D anime style, 8Kè¶…æ¸…, è‰²è°ƒç»Ÿä¸€", shot.cameraMove].filter(e => e && e.trim() !== "");
                return elements.join(", ");
            };

            const copyToClipboard = () => {
                const fullPrompt = shots.map((s, i) => `${i + 1}) ${generatePrompt(s)}`).join("\n");
                if (!fullPrompt) return;
                const textarea = document.createElement('textarea'); textarea.value = fullPrompt; document.body.appendChild(textarea);
                textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea);
                alert("å·²å¤åˆ¶å…¨éƒ¨æç¤ºè¯ï¼");
            };

            const handleImgUpload = (e, setPreview, setBase64) => { 
                const file = e.target.files[0]; 
                if (file) {
                    setPreview(URL.createObjectURL(file));
                    const reader = new FileReader();
                    reader.onloadend = () => setBase64(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (file.name.endsWith('.docx')) {
                        mammoth.extractRawText({arrayBuffer: e.target.result}).then(r => {
                            setScriptContext(r.value);
                            alert(`ğŸ“š å‰§æœ¬å¤§çº²å·²è£…è½½ (${r.value.length} å­—)ï¼AI å·²ç†è§£æ•´ä½“æ•…äº‹çº¿ã€‚`);
                        });
                    } else {
                        setScriptContext(e.target.result);
                        alert(`ğŸ“š å‰§æœ¬å¤§çº²å·²è£…è½½ï¼AI å·²ç†è§£æ•´ä½“æ•…äº‹çº¿ã€‚`);
                    }
                };
                if (file.name.endsWith('.docx')) reader.readAsArrayBuffer(file); else reader.readAsText(file);
            };

            // --- AI Chat Logic ---
            const handleChatSend = async (userText) => {
                setChatMessages(prev => [...prev, { role: 'user', content: userText }]);
                setIsChatLoading(true);
                
                try {
                    let endpoint = "", headers = {}, body = {};
                    const currentShotsJSON = JSON.stringify(shots);
                    
                    const systemPrompt = `ä½ æ˜¯Viduå¯¼æ¼”åŠ©æ‰‹ã€‚ä½ æ‹¥æœ‰å½“å‰çš„å‰§æœ¬å¤§çº²å’Œå·²ç”Ÿæˆçš„åˆ†é•œè¡¨ã€‚
                    ç”¨æˆ·ä¼šè®©ä½ ä¿®æ”¹åˆ†é•œæˆ–æä¾›èµ„æ–™ã€‚
                    ã€å½“å‰åˆ†é•œè¡¨æ•°æ®ã€‘: ${currentShotsJSON}
                    ã€å‰§æœ¬å¤§çº²ã€‘: ${scriptContext || "æ— "}
                    
                    ã€æŒ‡ä»¤ã€‘:
                    1. å¦‚æœç”¨æˆ·è¦æ±‚ä¿®æ”¹åˆ†é•œï¼Œè¯·ç”¨è‡ªç„¶çš„è¯­è¨€å›ç­”ï¼Œå¹¶**å¿…é¡»**åœ¨å›ç­”çš„æœ€åé™„å¸¦ä¸€ä¸ªæ–°çš„ JSON ä»£ç å—ï¼ˆ\`\`\`json [...] \`\`\`ï¼‰ï¼ŒåŒ…å«ä¿®æ”¹åçš„å®Œæ•´åˆ†é•œåˆ—è¡¨ã€‚
                    2. å¦‚æœç”¨æˆ·åªæ˜¯èŠå¤©æˆ–æŠ•å–‚èµ„æ–™ï¼Œæ­£å¸¸å›ç­”å³å¯ã€‚
                    3. JSONæ ¼å¼å¿…é¡»ä¸¥æ ¼éµå®ˆï¼š[{angle, shotSize, subject, visualDesc, background, timeAxis, cameraMove}]ã€‚
                    `;

                    // API Call Logic (Simplified to use same provider)
                    if (provider === 'offline') {
                        setTimeout(() => {
                            setChatMessages(prev => [...prev, { role: 'assistant', content: "ç¦»çº¿æ¨¡å¼æ— æ³•ä½¿ç”¨èŠå¤©åŠŸèƒ½ï¼Œè¯·é…ç½® Keyã€‚" }]);
                            setIsChatLoading(false);
                        }, 500);
                        return;
                    }

                    // Config (Reuse same config logic)
                    const apiMap = {
                        zhipu: { url: 'https://open.bigmodel.cn/api/paas/v4/chat/completions', model: 'glm-4-flash' },
                        deepseek: { url: 'https://api.deepseek.com/chat/completions', model: 'deepseek-chat' },
                        siliconflow: { url: 'https://api.siliconflow.cn/v1/chat/completions', model: 'deepseek-ai/DeepSeek-V3' }
                    };
                    const conf = apiMap[provider];
                    headers = { 'Content-Type': 'application/json' };
                    let key = '';
                    if (provider === 'zhipu') { key = generateZhipuJWT(cleanKey(zhipuKey)); headers['Authorization'] = `Bearer ${key}`; }
                    else { key = cleanKey(provider === 'deepseek' ? deepseekKey : siliconFlowKey); headers['Authorization'] = `Bearer ${key}`; }
                    
                    body = {
                        model: conf.model,
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userText }],
                        temperature: 0.5, stream: false
                    };

                    const response = await fetch(conf.url, { method: 'POST', headers, body: JSON.stringify(body) });
                    const resJson = await response.json();
                    let content = resJson.choices?.[0]?.message?.content || "AI æ— å“åº”";

                    // Parse potential JSON update
                    let shotUpdate = null;
                    const jsonMatch = content.match(/```json\s*(\[\s*\{[\s\S]*\}\s*\])\s*```/) || content.match(/\[\s*\{[\s\S]*\}\s*\]/);
                    if (jsonMatch) {
                        try {
                            shotUpdate = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                            // Clean up message to hide huge JSON block if desired, or keep it. Let's keep it but mark it.
                        } catch (e) { console.error("Chat JSON parse fail", e); }
                    }

                    setChatMessages(prev => [...prev, { role: 'assistant', content: content, shotUpdate }]);

                } catch (e) {
                    setChatMessages(prev => [...prev, { role: 'assistant', content: `é”™è¯¯: ${e.message}` }]);
                }
                setIsChatLoading(false);
            };

            const handleApplyShots = (newShots) => {
                setShots(newShots);
                setActiveTab('list'); // Switch back to list to see changes
                alert("åˆ†é•œè¡¨å·²æ›´æ–°ï¼");
            };

            // --- AI Generation Logic (Original) ---
            const handleAiPolish = async () => {
                if (!rawInput.trim()) return alert("è¯·å…ˆè¾“å…¥å½“å‰åœºæ¬¡çš„å‰§æœ¬æè¿°");
                setIsAiProcessing(true);
                let aiResults = [];

                try {
                    let endpoint = "", headers = {}, body = {};
                    let isVisionMode = false;

                    if (provider === 'zhipu' && (charImgBase64 || sceneImgBase64)) {
                        isVisionMode = true;
                        const k = cleanKey(zhipuKey); if (!k) throw new Error("ç¼ºå°‘æ™ºè°± Key");
                        const token = generateZhipuJWT(k);
                        endpoint = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
                        headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                        const contentParts = [
                            { type: "text", text: `ä½ ç°åœ¨æ˜¯Vidué¦–å¸­å¯¼æ¼”ã€‚ä½ éœ€è¦åŸºäºã€å‰§æœ¬å¤§çº²ã€‘å’Œã€å½“å‰å‰§æœ¬ã€‘ï¼Œç»“åˆã€å‚è€ƒå›¾ç‰‡ã€‘çš„è§†è§‰ç‰¹å¾ï¼Œç”Ÿæˆåˆ†é•œæç¤ºè¯ã€‚\n\nğŸ“œ å‰§æœ¬å¤§çº²(Context): ${scriptContext || "æ— "}\n\nğŸ¬ å½“å‰éœ€è¦ç”Ÿæˆçš„å‰§æœ¬: ${rawInput}\n\nâš ï¸ ä¸¥æ ¼è¦æ±‚ï¼š\n1. ä»”ç»†è§‚å¯Ÿå‚è€ƒå›¾ä¸­çš„äººç‰©ç‰¹å¾(å‘è‰²/æœé¥°)å’Œåœºæ™¯é£æ ¼ï¼Œå°†å…¶èå…¥æç¤ºè¯ã€‚\n2. ä½¿ç”¨æ—¶é—´è½´è¯­æ³•(0s-2s)æè¿°åŠ¨ä½œã€‚\n3. **å¿…é¡»åªè¿”å›çº¯ JSON æ•°ç»„**ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ ‡è®°ã€‚æ ¼å¼: [{angle, shotSize, subject, visualDesc, background, timeAxis, cameraMove}]ã€‚` }
                        ];
                        if (charImgBase64) contentParts.push({ type: "image_url", image_url: { url: charImgBase64 } });
                        if (sceneImgBase64) contentParts.push({ type: "image_url", image_url: { url: sceneImgBase64 } });
                        body = { model: "glm-4v", messages: [{ role: "user", content: contentParts }], temperature: 0.2 };
                    } else {
                        const systemPrompt = `ä½ ç°åœ¨æ˜¯ Vidu å¹³å°çš„é¦–å¸­åˆ†é•œå¸ˆã€‚\nã€è®°å¿†åº“ã€‘${scriptContext || "æ— "}\nã€æœ€é«˜æŒ‡ä»¤ã€‘\n1. ç‰¹æ•ˆå¼ºåˆ¶æ—¶é—´è½´ï¼šæ¶‰åŠå˜èº«/çˆ†ç‚¸æ—¶ï¼Œä½¿ç”¨ "(0s-2s)...; (2s-4s)..." æ”¾å…¥ 'timeAxis'ã€‚\n2. é€»è¾‘ä¸€è‡´æ€§ï¼šæ ¹æ®å¤§çº²è¡¥å…¨äººç‰©çŠ¶æ€ã€‚\n3. è¾“å‡ºæ ¼å¼ï¼šJSONæ•°ç»„ [{angle, shotSize, subject, background, timeAxis, cameraMove}]ã€‚\n4. ä¸¥ç¦è¾“å‡º JSON ä»¥å¤–çš„æ–‡å­—ã€‚`;
                        if (provider === 'offline') {
                            aiResults = [{ angle: "æ­£é¢", shotSize: "ç‰¹å†™", subject: rawInput, timeAxis: "(0s-2s) static; (2s-4s) action", background: "reference image 1", cameraMove: "static" }];
                        } else {
                            const apiMap = { zhipu: { url: 'https://open.bigmodel.cn/api/paas/v4/chat/completions', model: 'glm-4-flash' }, deepseek: { url: 'https://api.deepseek.com/chat/completions', model: 'deepseek-chat' }, siliconflow: { url: 'https://api.siliconflow.cn/v1/chat/completions', model: 'deepseek-ai/DeepSeek-V3' } };
                            const conf = apiMap[provider];
                            headers = { 'Content-Type': 'application/json' };
                            let key = '';
                            if (provider === 'zhipu') { key = generateZhipuJWT(cleanKey(zhipuKey)); headers['Authorization'] = `Bearer ${key}`; }
                            else { key = cleanKey(provider === 'deepseek' ? deepseekKey : siliconFlowKey); headers['Authorization'] = `Bearer ${key}`; }
                            body = { model: conf.model, messages: [{ role: "system", content: systemPrompt }, { role: "user", content: rawInput }], temperature: 0.3, stream: false };
                            endpoint = conf.url;
                        }
                    }

                    if (provider !== 'offline') {
                        const response = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(body) });
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        const resJson = await response.json();
                        let content = resJson.choices?.[0]?.message?.content;
                        if (!content) throw new Error("API è¿”å›å¼‚å¸¸");
                        try {
                            const jsonMatch = content.match(/\[\s*\{[\s\S]*\}\s*\]/);
                            if (jsonMatch) content = jsonMatch[0]; else content = content.replace(/```json|```/g, '').trim();
                            aiResults = JSON.parse(content);
                        } catch (parseError) {
                            console.error("Fallback", content);
                            aiResults = [{ angle: "æ­£é¢", shotSize: "ä¸­æ™¯", subject: "è§£æå¤±è´¥è½¬çº¯æ–‡æœ¬: " + content.substring(0, 100) + "...", visualDesc: "", timeAxis: "", cameraMove: "static" }];
                        }
                    }
                } catch (e) {
                    console.warn(e);
                    aiResults = [{ angle: "æ­£é¢", shotSize: "ä¸­æ™¯", subject: "ç”Ÿæˆå¤±è´¥: " + e.message, cameraMove: "static" }];
                }

                try {
                    const safeResults = Array.isArray(aiResults) ? aiResults : [aiResults];
                    const newShots = safeResults.map((res, idx) => ({
                        id: Date.now() + idx,
                        angle: res.angle || "æ­£é¢", shotSize: res.shotSize || "ä¸­æ™¯", subject: res.subject || "ä¸»ä½“", visualDesc: res.visualDesc || "", face: res.face || "çœ¼ç›ç²¾è‡´, äº”å®˜æ¸…æ™°", background: res.background || "reference image 1", dynamics: res.dynamics || "å°åŠ¨æ€", timeAxis: res.timeAxis || "", cameraMove: res.cameraMove || "static shot"
                    }));
                    setShots(newShots);
                    setActiveTab('list'); // Switch to list view on generate
                } catch (mapError) { alert("æ•°æ®å¤„ç†é”™è¯¯"); }
                setIsAiProcessing(false);
            };

            const addShot = () => setShots([...shots, { id: Date.now(), angle: "æ­£é¢", shotSize: "ä¸­æ™¯", subject: "", face: "", background: "", dynamics: "å°åŠ¨æ€", cameraMove: "static shot" }]);
            const removeShot = (id) => setShots(shots.filter(s => s.id !== id));

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-[fadeIn_0.2s_ease-out]" onClick={onClose}>
                    <div className="bg-[#0f111a] border border-purple-500/30 rounded-2xl w-full max-w-6xl h-[90vh] flex flex-col shadow-[0_0_60px_rgba(168,85,247,0.15)] animate-[modal-pop_0.3s_cubic-bezier(0.34,1.56,0.64,1)] overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-5 border-b border-white/10 bg-gradient-to-r from-purple-900/20 to-transparent flex-shrink-0">
                            <div className="flex items-center gap-3">
                                <Wand2 className="w-6 h-6 text-purple-400" />
                                <div><h3 className="text-xl font-bold text-white">Vidu å¯¼æ¼”å° V8.0 <span className="text-xs bg-purple-500/20 text-purple-300 border border-purple-500/50 px-1 rounded ml-2">åŠ©ç†ç‰ˆ</span></h3><p className="text-[10px] text-white/40 uppercase tracking-widest">GLM-4V Multimodal & Chat Assistant</p></div>
                            </div>
                            <button onClick={onClose}><X className="w-6 h-6 text-white/40 hover:text-white" /></button>
                        </div>

                        <div className="flex-1 overflow-hidden flex flex-col md:flex-row">
                            {/* Left Control Panel */}
                            <div className="w-full md:w-1/3 bg-black/20 p-6 border-r border-white/10 flex flex-col gap-5 overflow-y-auto custom-scrollbar">
                                <div className="space-y-2">
                                    <div className="flex justify-between"><div className="text-[10px] font-bold text-cyan-300 uppercase flex items-center gap-1"><Eye className="w-3 h-3" /> ç¬¬ä¸€æ­¥: è§†è§‰èµ„äº§</div>{provider === 'zhipu' && <span className="text-[9px] text-emerald-400 border border-emerald-500/30 px-1 rounded">Vision Ready</span>}</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="aspect-video border border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 relative overflow-hidden group" onClick={() => charImgRef.current.click()}>{charImg ? <img src={charImg} className="absolute inset-0 w-full h-full object-cover" /> : <div className="text-center text-white/30"><Users className="w-6 h-6 mx-auto mb-1" /><span className="text-[9px]">è§’è‰²å›¾</span></div>}<input type="file" ref={charImgRef} onChange={e => handleImgUpload(e, setCharImg, setCharImgBase64)} className="hidden" accept="image/*" /></div>
                                        <div className="aspect-video border border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 relative overflow-hidden group" onClick={() => sceneImgRef.current.click()}>{sceneImg ? <img src={sceneImg} className="absolute inset-0 w-full h-full object-cover" /> : <div className="text-center text-white/30"><Clapperboard className="w-6 h-6 mx-auto mb-1" /><span className="text-[9px]">åœºæ™¯å›¾</span></div>}<input type="file" ref={sceneImgRef} onChange={e => handleImgUpload(e, setSceneImg, setSceneImgBase64)} className="hidden" accept="image/*" /></div>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center"><div className="text-[10px] font-bold text-purple-300 uppercase flex items-center gap-1"><BrainCircuit className="w-3 h-3" /> ç¬¬äºŒæ­¥: AI é…ç½®</div><button onClick={() => setShowApiSettings(!showApiSettings)} className="text-[10px] text-white/50 hover:text-white underline">é…ç½® Keys</button></div>
                                    <select value={provider} onChange={e => setProvider(e.target.value)} className="w-full bg-black/40 border border-purple-500/30 rounded-lg px-2 py-2 text-white text-xs focus:outline-none"><option value="offline">ç¦»çº¿æ¨¡å¼ (Mock)</option><option value="zhipu">æ™ºè°± AI (æ¨èGLM-4V)</option><option value="siliconflow">SiliconFlow (DeepSeek)</option><option value="deepseek">DeepSeek (å®˜ç½‘)</option></select>
                                    {showApiSettings && (<div className="p-3 bg-white/5 rounded-lg border border-white/10 space-y-2 animate-[fadeIn_0.2s]"><input type="password" value={zhipuKey} onChange={e => setZhipuKey(e.target.value)} placeholder="Zhipu Key" className="w-full bg-black/60 border border-white/10 rounded px-2 py-1 text-[10px] text-white" /><input type="password" value={siliconFlowKey} onChange={e => setSiliconFlowKey(e.target.value)} placeholder="SiliconFlow Key" className="w-full bg-black/60 border border-white/10 rounded px-2 py-1 text-[10px] text-white" /><input type="password" value={deepseekKey} onChange={e => setDeepseekKey(e.target.value)} placeholder="DeepSeek Key" className="w-full bg-black/60 border border-white/10 rounded px-2 py-1 text-[10px] text-white" /></div>)}
                                </div>
                                <div className="flex-1 flex flex-col gap-2">
                                    <div className="flex justify-between items-center"><div className="text-[10px] font-bold text-pink-300 uppercase flex items-center gap-1"><FileText className="w-3 h-3" /> ç¬¬ä¸‰æ­¥: å‰§æœ¬ä¸æŒ‡ä»¤</div><div><input type="file" ref={fileInputRef} className="hidden" accept=".docx,.txt" onChange={handleFileUpload} /><button onClick={() => fileInputRef.current.click()} className="text-[9px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-white transition-colors flex items-center gap-1"><BookOpen className="w-3 h-3" /> å¯¼å…¥å¤§çº²</button></div></div>
                                    {scriptContext ? (<div className="text-[9px] bg-emerald-500/10 border border-emerald-500/30 text-emerald-300 px-2 py-1.5 rounded flex items-center gap-2 animate-[fadeIn_0.2s]"><BookOpen className="w-3 h-3" /><span>å¤§çº²å·²åŠ è½½ï¼šAI å·²ç†è§£ä¸Šä¸‹æ–‡é€»è¾‘</span></div>) : (<div className="text-[9px] bg-white/5 border border-white/10 text-white/30 px-2 py-1.5 rounded flex items-center gap-2"><AlertTriangle className="w-3 h-3" /><span>æœªåŠ è½½å¤§çº²ï¼ŒAI ä»…æ ¹æ®å½“å‰è¾“å…¥ç”Ÿæˆ</span></div>)}
                                    <textarea value={rawInput} onChange={e => setRawInput(e.target.value)} placeholder="è¾“å…¥åœºæ¬¡æè¿°..." className="flex-1 w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white text-sm focus:outline-none focus:border-purple-400 transition-all placeholder-white/20 resize-none font-mono leading-relaxed" />
                                    <button onClick={handleAiPolish} disabled={isAiProcessing} className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-50 transition-all shadow-lg active:scale-95">{isAiProcessing ? <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Sparkles className="w-4 h-4" />}ç”Ÿæˆåˆ†é•œ (Start)</button>
                                </div>
                            </div>

                            {/* Right Column: Shot List & Chat */}
                            <div className="w-full md:w-2/3 bg-[#050505] flex flex-col relative border-l border-white/5">
                                {/* Tabs */}
                                <div className="flex border-b border-white/10">
                                    <button onClick={() => setActiveTab('list')} className={`flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'list' ? 'bg-white/5 text-white border-b-2 border-purple-500' : 'text-white/40 hover:text-white'}`}>åˆ†é•œè¡¨ ({shots.length})</button>
                                    <button onClick={() => setActiveTab('chat')} className={`flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'chat' ? 'bg-white/5 text-white border-b-2 border-purple-500' : 'text-white/40 hover:text-white'}`}>å¯¼æ¼”åŠ©ç† (Chat)</button>
                                </div>

                                <div className="flex-1 overflow-hidden relative">
                                    {activeTab === 'list' ? (
                                        <div className="h-full overflow-y-auto custom-scrollbar p-6 space-y-3 pb-20">
                                            {shots.length === 0 && !isAiProcessing && (
                                                <div className="h-full flex flex-col items-center justify-center text-white/20 select-none pointer-events-none">
                                                    <Clapperboard className="w-16 h-16 mb-4 opacity-20" /><p className="text-sm font-mono">ç­‰å¾…ç”Ÿæˆ...</p>
                                                </div>
                                            )}
                                            <div className="flex justify-end mb-2"><button onClick={copyToClipboard} className="text-[10px] bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded text-white flex items-center gap-1 transition-all"><Copy className="w-3 h-3" /> å¤åˆ¶å…¨éƒ¨</button></div>
                                            {shots.map((shot, index) => (
                                                <div key={shot.id} className="bg-white/5 border border-white/10 rounded-xl p-4 relative group hover:border-purple-500/30 transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex items-center gap-2"><span className="w-6 h-6 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center font-bold text-xs">{index + 1}</span><span className="text-xs text-white/60 font-mono">Shot {index + 1}</span>{shot.timeAxis && <span className="text-[9px] border border-yellow-500/30 text-yellow-300 px-1.5 py-0.5 rounded">Timeline</span>}</div>
                                                        <div className="flex gap-2"><span className="text-[9px] border border-cyan-500/30 text-cyan-300 px-1.5 py-0.5 rounded">{shot.angle}</span><span className="text-[9px] border border-pink-500/30 text-pink-300 px-1.5 py-0.5 rounded">{shot.shotSize}</span></div>
                                                    </div>
                                                    <div className="bg-black/40 rounded-lg p-3 border border-white/5 font-mono text-sm text-gray-300 break-words leading-relaxed select-all">{generatePrompt(shot)}</div>
                                                    <button onClick={() => removeShot(shot.id)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 p-1.5 text-white/20 hover:text-rose-400 transition-all"><Trash2 className="w-3 h-3" /></button>
                                                </div>
                                            ))}
                                            {shots.length > 0 && <div className="absolute bottom-4 left-0 w-full flex justify-center pointer-events-none"><button onClick={addShot} className="pointer-events-auto bg-white/10 hover:bg-white/20 border border-white/10 text-white text-xs px-6 py-2 rounded-full backdrop-blur-md transition-all">+ æ‰‹åŠ¨åŠ é•œ</button></div>}
                                        </div>
                                    ) : (
                                        <ChatComponent messages={chatMessages} onSend={handleChatSend} isLoading={isChatLoading} onApplyShots={handleApplyShots} />
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Component (ä¸»å…¥å£ - ä¿æŒä¸å˜) ---
        function App() {
            const [records, setRecords] = useState([]);
            const [dateStr, setDateStr] = useState(() => new Date().toISOString().split('T')[0]);
            const [remainingPoints, setRemainingPoints] = useState('');
            const [myShots, setMyShots] = useState('');
            const [partnerShots, setPartnerShots] = useState('');
            const [scriptName, setScriptName] = useState('');
            const [isTopUp, setIsTopUp] = useState(false);
            const [showDanger, setShowDanger] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [activeDetail, setActiveDetail] = useState(null);
            const [showGame, setShowGame] = useState(false);
            const [showDirector, setShowDirector] = useState(false);
            const [baseEfficiency, setBaseEfficiency] = useState(60); 
            const [triggerThreshold, setTriggerThreshold] = useState(1000);

            useEffect(() => { const saved = localStorage.getItem('render_tracker_data'); if (saved) { try { setRecords(JSON.parse(saved)); } catch (e) { console.error(e); } } }, []);
            useEffect(() => { localStorage.setItem('render_tracker_data', JSON.stringify(records)); }, [records]);

            const lastRecord = records.length > 0 ? records[0] : null;
            const totalShots = (parseInt(myShots) || 0) + (parseInt(partnerShots) || 0);

            const efficiencyStreak = useMemo(() => {
                let streak = 0;
                for (const r of records) { if (r.type === 'normal') { if (!r.isInefficient) streak++; else break; } }
                return streak;
            }, [records]);

            const handleAdd = () => {
                if (!remainingPoints) return;
                const currentPoints = parseInt(remainingPoints);
                const shots = totalShots; 
                let consumed = 0;
                let type = 'normal';
                if (!lastRecord) { type = 'initial'; consumed = 0; } else if (isTopUp) { type = 'topup'; consumed = 0; } else { consumed = lastRecord.remaining - currentPoints; }
                const currentCPR = shots > 0 ? (consumed / shots) : 0;
                const isInefficient = type === 'normal' && consumed > triggerThreshold && (shots === 0 || currentCPR > baseEfficiency);
                const newRecord = { id: Date.now(), date: dateStr.replace(/-/g, '/'), timestamp: new Date(dateStr).toISOString(), remaining: currentPoints, consumed: consumed, shots: shots, myShots: parseInt(myShots) || 0, partnerShots: parseInt(partnerShots) || 0, scriptName: scriptName, type: type, isInefficient: isInefficient, cpr: currentCPR.toFixed(1) };
                setRecords([newRecord, ...records]);
                setRemainingPoints(''); setMyShots(''); setPartnerShots(''); setScriptName(''); setIsTopUp(false);
            };

            const handleDelete = (id) => setRecords(records.filter(r => r.id !== id));
            const handleUpdateRecord = (updatedRecord) => { setRecords(records.map(r => r.id === updatedRecord.id ? updatedRecord : r)); setEditingRecord(null); };
            const clearAll = () => { if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ")) setRecords([]); };
            const exportData = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "vidu_tracker_data.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); };

            const stats = useMemo(() => {
                const normalRecords = records.filter(r => r.type === 'normal');
                const totalConsumed = normalRecords.reduce((acc, curr) => acc + curr.consumed, 0);
                const totalShots = normalRecords.reduce((acc, curr) => acc + curr.shots, 0);
                const avgCPR = totalShots > 0 ? (totalConsumed / totalShots).toFixed(1) : 0;
                const inefficiencyCount = records.filter(r => r.isInefficient).length;
                const uniqueScripts = new Set(normalRecords.map(r => r.scriptName).filter(Boolean)).size;
                return { totalConsumed, totalShots, avgCPR, inefficiencyCount, uniqueScripts };
            }, [records]);

            const previewConsumption = lastRecord && !isTopUp && remainingPoints ? (lastRecord.remaining - parseInt(remainingPoints)) : null;
            const previewCPR = (!isTopUp && previewConsumption && totalShots > 0) ? (previewConsumption / totalShots).toFixed(1) : null;

            return (
                <div className="min-h-screen relative p-4 md:p-8 font-sans selection:bg-pink-500/30 selection:text-white">
                    <div className="fixed inset-0 -z-10 pointer-events-none bg-[#050505] overflow-hidden">
                        <div className="absolute w-[60vw] h-[60vw] bg-purple-600/20 rounded-full blur-[120px] mix-blend-screen animate-[aurora-1_15s_infinite_alternate]"></div>
                        <div className="absolute w-[50vw] h-[50vw] bg-cyan-500/20 rounded-full blur-[100px] mix-blend-screen animate-[aurora-2_20s_infinite_alternate]"></div>
                        <div className="absolute w-[40vw] h-[40vw] bg-pink-500/20 rounded-full blur-[90px] mix-blend-screen animate-[aurora-3_12s_infinite_alternate]"></div>
                        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 mix-blend-overlay"></div>
                    </div>

                    {showDanger && <div className="fixed inset-0 z-[100] bg-red-600 flex items-center justify-center cursor-pointer animate-[extreme-shake_0.5s_infinite]" onClick={() => setShowDanger(false)}><div className="flex flex-col items-center gap-12"><h1 className="text-[15rem] md:text-[20rem] font-black text-black leading-none select-none flex flex-col items-center drop-shadow-[10px_10px_0_rgba(255,255,255,0.2)]"><span>å¿«</span><span>è·‘</span></h1></div></div>}
                    {showGame && <GameModal onClose={() => setShowGame(false)} />}
                    {showDirector && <DirectorModal onClose={() => setShowDirector(false)} />}
                    {editingRecord && <EditModal record={editingRecord} onClose={() => setEditingRecord(null)} onSave={handleUpdateRecord} baseEfficiency={baseEfficiency} />}
                    {activeDetail && <DetailModal title={activeDetail === 'consumption' ? 'æ¯æ—¥ç®—åŠ›æ¶ˆè€—æ˜ç»†' : activeDetail === 'shots' ? 'æ¯æ—¥äº§å‡º (æˆ‘ vs é˜Ÿå‹)' : activeDetail === 'cpr' ? 'æ¯æ—¥ CPR æ•ˆç‡èµ°åŠ¿' : activeDetail === 'scripts' ? 'å‰§æœ¬æ•ˆç›Šå®¡è®¡é¢æ¿' : 'ä½æ•ˆè­¦å‘Šè®°å½•'} type={activeDetail} data={records} onClose={() => setActiveDetail(null)} baseEfficiency={baseEfficiency} />}

                    <div className="max-w-6xl mx-auto space-y-8 relative z-10">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative">
                            <div>
                                <h1 className="text-3xl md:text-4xl font-black tracking-tighter flex flex-col md:flex-row md:items-center gap-3 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                                    <span className="bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 via-purple-300 to-pink-300 animate-pulse">Vidu-ai è§†é¢‘æŠ½å¡</span>
                                    <span className="text-white text-xl md:text-2xl font-bold flex items-center gap-2">ç§¯åˆ†æ¶ˆè€—è®¡ç®—å¹³å°<div className="flex flex-col items-start"><span className="text-xs bg-white/10 text-white px-2 py-0.5 rounded border border-white/20 tracking-widest uppercase backdrop-blur-md">æ˜“ä¸“å±</span><span className="text-[9px] text-white/40 scale-90 origin-left mt-0.5 tracking-wider font-normal">å—æ˜Œé…±æ²¹å…¬å¸</span></div></span>
                                </h1>
                                <p className="text-white/40 text-sm mt-2 font-medium tracking-wide flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>System Online Â· ä¸ƒå½©é«˜æ–¯å¼•æ“æ¸²æŸ“ä¸­</p>
                            </div>
                            <div className="hidden lg:flex absolute left-1/2 ml-[113px] top-1/2 -translate-x-1/2 -translate-y-1/2 flex-col items-center justify-center cursor-pointer group z-20 hover:scale-110 transition-transform duration-300" onClick={() => setShowDanger(true)}>
                                <AlertTriangle className="w-20 h-20 text-red-600 animate-pulse drop-shadow-[0_0_35px_rgba(220,38,38,1)]" />
                                <span className="text-red-600 font-black text-[10px] tracking-[0.2em] mt-1 bg-black/80 px-4 py-2 rounded border border-red-600/80 backdrop-blur-md shadow-[0_0_15px_rgba(220,38,38,0.6)] whitespace-nowrap opacity-100">å±é™©ï¼ï¼ç¦æ­¢æ‰“å¼€ï¼ï¼</span>
                            </div>
                            <div className="flex items-center gap-3 relative z-10">
                                {efficiencyStreak > 0 && <div className="hidden md:flex items-center gap-2 bg-gradient-to-r from-orange-500/20 to-red-500/20 border border-orange-500/30 px-3 py-2 rounded-full backdrop-blur-md animate-[pulse-glow_2s_infinite]"><Flame className="w-4 h-4 text-orange-400" /><span className="text-xs font-bold text-orange-200">{efficiencyStreak} Days Efficient</span></div>}
                                <button onClick={() => setShowGame(true)} className="bg-white/5 hover:bg-white/10 border border-white/10 p-3 rounded-full transition-all hover:scale-110 hover:shadow-[0_0_15px_rgba(255,255,255,0.3)] group" title="Play Neural Gacha"><Gamepad2 className="w-5 h-5 text-purple-300 group-hover:text-purple-100" /></button>
                                <div className="hidden md:flex gap-4 text-xs font-bold text-white/80 bg-white/5 backdrop-blur-md border border-white/10 px-5 py-3 rounded-full shadow-lg">
                                    <div className="flex items-center gap-2"><div className="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_10px_#34d399]"></div><span className="text-emerald-300">Target &lt; {baseEfficiency}</span></div>
                                    <div className="w-px h-4 bg-white/10"></div>
                                    <div className="flex items-center gap-2"><div className="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_10px_#f43f5e]"></div><span className="text-rose-400">Alert &gt; {baseEfficiency}</span></div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            {[
                                { id: 'consumption', label: "ç®—åŠ›æ€»æ¶ˆè€—", value: stats.totalConsumed.toLocaleString(), icon: TrendingDown, color: "text-white" },
                                { id: 'shots', label: "æ€»ç”Ÿæˆé•œå¤´", value: stats.totalShots, icon: Users, color: "text-cyan-300" },
                                { id: 'cpr', label: "å¹³å‡ CPR", value: stats.avgCPR, sub: "åˆ†/é•œ", icon: BarChart2, color: parseFloat(stats.avgCPR) > baseEfficiency ? "text-rose-400 drop-shadow-[0_0_8px_rgba(244,63,94,0.6)]" : "text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.6)]" },
                                { id: 'inefficiency', label: "ä½æ•ˆè­¦å‘Š", value: stats.inefficiencyCount, icon: AlertTriangle, color: stats.inefficiencyCount > 0 ? "text-rose-500" : "text-emerald-500" },
                                { id: 'scripts', label: "æ´»è·ƒå‰§æœ¬", value: stats.uniqueScripts, icon: Clapperboard, color: "text-indigo-400", sub: "Projects" },
                                { id: 'director', label: "æç¤ºè¯å¯¼æ¼”", value: "OPEN", icon: Wand2, color: "text-purple-400", sub: "Tool", action: true }
                            ].map((item, idx) => (
                                <Card key={idx} onClick={() => item.action ? setShowDirector(true) : setActiveDetail(item.id)} className="group">
                                    <div className="text-white/40 text-[10px] uppercase tracking-widest font-bold mb-3 flex items-center justify-between">
                                        <div className="flex items-center gap-2"><item.icon className="w-3.5 h-3.5" /> {item.label}</div>
                                        <ChevronRight className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </div>
                                    <div className={`text-2xl md:text-3xl font-mono font-bold ${item.color}`}>{item.value}</div>
                                    {item.sub && <div className="text-[10px] text-white/20 mt-1 font-medium">{item.sub}</div>}
                                </Card>
                            ))}
                        </div>

                        <Card className="!bg-white/5 !border-white/10 shadow-[0_0_50px_-20px_rgba(255,255,255,0.1)]">
                            <div className="flex flex-col gap-6">
                                <div className="flex justify-between items-center border-b border-white/5 pb-4">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2"><PlusCircle className="w-5 h-5 text-cyan-400" /> æ•°æ®å½•å…¥ç»ˆç«¯</h2>
                                    {lastRecord && <span className="text-xs font-mono font-bold text-cyan-200/70 bg-white/5 px-3 py-1.5 rounded border border-white/10">LAST: {lastRecord.remaining}</span>}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-12 gap-5 items-end">
                                    <div className="md:col-span-12 flex items-center gap-3 mb-1">
                                        <label className="group flex items-center gap-3 cursor-pointer select-none">
                                            <div className={`w-12 h-6 rounded-full p-1 transition-all duration-300 ${isTopUp ? 'bg-emerald-500/80' : 'bg-white/10'}`} onClick={() => setIsTopUp(!isTopUp)}><div className={`w-4 h-4 rounded-full bg-white shadow-md transform transition-all duration-300 ${isTopUp ? 'translate-x-6' : 'translate-x-0'}`}></div></div>
                                            <span className={`text-xs font-bold uppercase tracking-wide transition-colors ${isTopUp ? 'text-emerald-400' : 'text-slate-500 group-hover:text-slate-400'}`}>{isTopUp ? "RECHARGE MODE" : "AUDIT MODE"}</span>
                                        </label>
                                    </div>
                                    <div className="md:col-span-3 relative group"><label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-white transition-colors">Date</label><input type="date" value={dateStr} onChange={(e) => setDateStr(e.target.value)} className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-white/30 focus:bg-black/40 transition-all font-mono text-lg" /></div>
                                    <div className="md:col-span-3 relative group"><label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-white transition-colors">Balance</label><input type="number" value={remainingPoints} onChange={(e) => setRemainingPoints(e.target.value)} placeholder="0" className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-white/30 focus:bg-black/40 transition-all font-mono text-lg" /></div>
                                    <div className="md:col-span-6 relative group"><label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-indigo-400 transition-colors">Script Name (å‰§æœ¬)</label><input type="text" value={scriptName} onChange={(e) => setScriptName(e.target.value)} placeholder="e.g. Star Wars V" disabled={isTopUp} className={`w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-indigo-500/50 focus:bg-black/40 transition-all font-mono text-lg ${isTopUp ? 'opacity-20 cursor-not-allowed' : ''}`} /></div>
                                    <div className="md:col-span-4 relative group"><label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-cyan-400 transition-colors">My Shots</label><input type="number" value={myShots} onChange={(e) => setMyShots(e.target.value)} placeholder="Me" disabled={isTopUp} className={`w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-cyan-500/50 focus:bg-black/40 transition-all font-mono text-lg ${isTopUp ? 'opacity-20 cursor-not-allowed' : ''}`} /></div>
                                    <div className="md:col-span-4 relative group"><label className="block text-[10px] font-bold text-white/30 mb-2 uppercase tracking-wider ml-1 group-focus-within:text-pink-400 transition-colors">Partner</label><input type="number" value={partnerShots} onChange={(e) => setPartnerShots(e.target.value)} placeholder="Ta" disabled={isTopUp} className={`w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/10 focus:outline-none focus:border-pink-500/50 focus:bg-black/40 transition-all font-mono text-lg ${isTopUp ? 'opacity-20 cursor-not-allowed' : ''}`} /></div>
                                    <div className="md:col-span-4"><button onClick={handleAdd} disabled={!remainingPoints} className="w-full h-[52px] bg-white/10 hover:bg-white/20 disabled:bg-black/20 disabled:text-white/20 disabled:cursor-not-allowed text-white font-bold rounded-lg transition-all border border-white/10 active:scale-95 flex items-center justify-center gap-2 group"><Save className="w-4 h-4 group-hover:scale-110 transition-transform" /><span>COMMIT</span></button></div>
                                </div>
                                {!isTopUp && previewConsumption !== null && (
                                    <div className={`mt-2 rounded-lg p-4 text-center border backdrop-blur-md transition-all animate-pulse ${previewConsumption > triggerThreshold && previewCPR > baseEfficiency ? 'bg-rose-500/10 border-rose-500/20' : 'bg-white/5 border-white/10'}`}>
                                        <div className="flex justify-center items-center gap-8">
                                            <div><span className="text-white/30 text-[10px] uppercase font-bold tracking-widest block mb-1">Cost</span><div className={`font-mono font-bold text-xl text-white`}>{previewConsumption}</div></div>
                                            {previewCPR && (<>
                                                <div className="w-px h-8 bg-white/10"></div>
                                                <div><span className="text-white/30 text-[10px] uppercase font-bold tracking-widest block mb-1">CPR</span><div className={`font-mono font-bold text-xl flex items-center gap-1 ${parseFloat(previewCPR) > baseEfficiency ? 'text-rose-400' : 'text-emerald-400'}`}>{previewCPR}</div></div>
                                            </>)}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </Card>

                        <div className="space-y-5">
                            <div className="flex justify-between items-end px-2 border-b border-white/5 pb-2">
                                <h2 className="text-lg font-bold text-white flex items-center gap-2"><History className="w-4 h-4 text-cyan-500" /> LOGS</h2>
                                <div className="flex gap-3"><button onClick={exportData} className="flex items-center gap-1 text-[10px] font-bold text-white/40 hover:text-cyan-400 transition-colors uppercase tracking-wider"><Download className="w-3 h-3" /> Export</button><button onClick={clearAll} className="text-[10px] font-bold text-white/40 hover:text-rose-400 transition-colors uppercase tracking-wider">Clear Data</button></div>
                            </div>
                            <div className="space-y-3">
                                {records.length === 0 ? <div className="text-center py-16 text-white/20 bg-white/5 rounded-lg border border-dashed border-white/10"><p className="font-mono text-sm">NO DATA DETECTED</p></div> : 
                                    records.map((record) => (
                                        <div key={record.id} className={`group relative backdrop-blur-md bg-white/5 border border-white/5 hover:bg-white/10 rounded-lg p-4 transition-all duration-300 hover:border-white/10 ${record.isInefficient ? 'shadow-[inset_2px_0_0_0_#f43f5e]' : record.type === 'topup' ? 'shadow-[inset_2px_0_0_0_#10b981]' : 'shadow-[inset_2px_0_0_0_#6366f1]'}`}>
                                            <div className="flex justify-between items-center">
                                                <div className="flex flex-col gap-2">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-white/60 text-xs font-mono">{record.date}</span>
                                                        {record.type === 'topup' && <Badge type="success">RECHARGE</Badge>}
                                                        {record.type === 'initial' && <Badge type="neutral">INIT</Badge>}
                                                        {record.isInefficient && <Badge type="danger">INEFFICIENT</Badge>}
                                                        {record.scriptName && <Badge type="script">{record.scriptName}</Badge>}
                                                    </div>
                                                    <div className="flex items-center gap-4 md:gap-8 mt-1">
                                                        <div className="flex flex-col"><span className="text-[10px] text-white/20 uppercase font-bold">Balance</span><span className="text-white/80 font-mono">{record.remaining}</span></div>
                                                        {record.type === 'normal' && (
                                                            <>
                                                                <div className="w-px h-6 bg-white/5"></div>
                                                                <div className="flex flex-col"><span className="text-[10px] text-white/20 uppercase font-bold">Cost</span><span className="text-white font-bold font-mono">{record.consumed}</span></div>
                                                                <div className="w-px h-6 bg-white/5"></div>
                                                                <div className="flex flex-col"><span className="text-[10px] text-white/20 uppercase font-bold">Shots</span><div className="flex items-center gap-2"><span className="text-cyan-300 font-mono">{record.shots}</span>{(record.myShots !== undefined || record.partnerShots !== undefined) && (<span className="text-[10px] text-white/30 font-mono">{record.myShots}+{record.partnerShots}</span>)}</div></div>
                                                                {record.shots > 0 && (<div className={`ml-auto hidden md:flex flex-col items-end px-3 py-1 rounded border ${parseFloat(record.cpr) > baseEfficiency ? 'bg-rose-500/10 border-rose-500/20' : 'bg-emerald-500/10 border-emerald-500/20'}`}><span className={`text-[10px] uppercase font-bold ${parseFloat(record.cpr) > baseEfficiency ? 'text-rose-500' : 'text-emerald-500'}`}>CPR</span><span className={`font-mono text-sm ${parseFloat(record.cpr) > baseEfficiency ? 'text-rose-300' : 'text-emerald-300'}`}>{record.cpr}</span></div>)}
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => setEditingRecord(record)} className="p-2 text-white/20 hover:text-cyan-400 hover:bg-white/5 rounded transition-all"><Edit2 className="w-4 h-4" /></button><button onClick={() => handleDelete(record.id)} className="p-2 text-white/20 hover:text-rose-500 hover:bg-white/5 rounded transition-all"><Trash2 className="w-4 h-4" /></button></div>
                                            </div>
                                        </div>
                                    ))
                                }
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
